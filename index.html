<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Casino - Situs Game Demo Terlengkap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Slate 900 */
            scroll-behavior: smooth;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1E293B; }
        ::-webkit-scrollbar-thumb { background: #F59E0B; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #D97706; }
        
        .hero-bg {
            background-image: linear-gradient(to top, #0F172A, rgba(15, 23, 42, 0.7)), url('https://placehold.co/1920x1080/0a0a0a/eab308?text=Galaxy+Casino');
            background-size: cover;
            background-position: center;
        }

        .modal-content, .auth-form {
            animation: slide-up 0.3s ease-out;
        }
        @keyframes slide-up {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .auth-input {
            background-color: #1E293B; border: 1px solid #334155; border-radius: 0.5rem;
            padding: 0.75rem 1rem; color: #F1F5F9; width: 100%; transition: all 0.2s;
        }
        .auth-input:focus {
            outline: none; border-color: #F59E0B;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5);
        }
        
        .scratch-card-cover {
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        #wheelCanvas {
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .keno-ball { transition: all 0.3s ease; }
        .keno-ball.selected { background-color: #F59E0B; border-color: #FBBF24; color: #1E293B; transform: scale(1.1); }
        .keno-ball.drawn { background-color: #10B981; border-color: #34D399; }
        .keno-ball.match { background-color: #3B82F6; border-color: #60A5FA; animation: pulse 1s infinite; }

        @keyframes pulse { 0%, 100% { transform: scale(1.1); } 50% { transform: scale(1.2); } }
        
        .card {
            width: 50px;
            height: 70px;
            border-radius: 5px;
            background-color: white;
            border: 1px solid #333;
            color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        .card.red { color: #DC2626; }
        .card.hidden-card { background-color: #DC2626; }

        /* Responsive Canvas Styling */
        .canvas-container {
            width: 100%;
            max-width: 350px; /* Max size for wheel on larger screens */
            aspect-ratio: 1 / 1;
            margin-left: auto;
            margin-right: auto;
        }
        #wheelCanvas, #crash-canvas, #trading-canvas {
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="text-gray-200 text-sm sm:text-base">

    <!-- Header / Navbar -->
    <header class="bg-slate-800/50 backdrop-blur-sm sticky top-0 z-50 border-b border-slate-700">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="#" class="text-xl sm:text-2xl font-bold text-amber-400">
                <i data-lucide="gem" class="inline-block mr-1 sm:mr-2"></i>GalaxyCasino
            </a>
            <div id="auth-buttons" class="flex items-center space-x-2">
                <button id="show-login-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-300 text-xs sm:text-sm">Masuk</button>
                <button id="show-register-btn" class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-300 text-xs sm:text-sm">Daftar</button>
            </div>
            <div id="user-session" class="hidden items-center space-x-2 sm:space-x-4">
                <div class="text-right">
                    <span id="username-display" class="font-semibold text-amber-400 block text-xs sm:text-sm"></span>
                    <p class="mt-1 text-xs sm:text-sm font-bold bg-slate-700/50 text-amber-300 px-2 sm:px-3 py-1 rounded-md shadow-inner">Saldo: <span id="balance-display"></span></p>
                </div>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-3 sm:px-4 rounded-lg transition duration-300 text-xs sm:text-sm">Keluar</button>
            </div>
        </nav>
    </header>

    <!-- Auth Section -->
    <section id="auth-section" class="min-h-[80vh] flex items-center justify-center container mx-auto px-4">
        <!-- Login Form -->
        <div id="login-form" class="auth-form bg-slate-900 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-sm sm:max-w-md hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-center text-amber-400 mb-6">Selamat Datang Kembali</h2>
            <form id="login-form-submit" class="space-y-4">
                <input type="text" id="login-username" placeholder="Username" class="auth-input" required>
                <input type="password" id="login-password" placeholder="Password" class="auth-input" required>
                <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg text-base sm:text-lg transition duration-300">Masuk</button>
            </form>
            <p id="login-error" class="text-red-500 text-center mt-4 h-5"></p>
            <p class="text-center mt-4 text-gray-400">Belum punya akun? <button id="switch-to-register" class="font-semibold text-amber-400 hover:underline">Daftar di sini</button></p>
        </div>
        <!-- Register Form -->
        <div id="register-form" class="auth-form bg-slate-900 p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-sm sm:max-w-md hidden">
            <h2 class="text-2xl sm:text-3xl font-bold text-center text-amber-400 mb-6">Buat Akun Baru</h2>
            <form id="register-form-submit" class="space-y-4">
                <input type="text" id="register-username" placeholder="Username (min. 5 karakter)" class="auth-input" required>
                <input type="tel" id="register-phone" placeholder="Nomor HP (Contoh: 08123456789)" class="auth-input" required>
                <input type="email" id="register-email" placeholder="Email (Contoh: user@email.com)" class="auth-input" required>
                <input type="password" id="register-password" placeholder="Password (min. 8 karakter)" class="auth-input" required>
                <p id="register-error" class="text-red-500 text-center h-5 text-sm"></p>
                <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg text-base sm:text-lg transition duration-300">Daftar</button>
            </form>
            <p class="text-center mt-4 text-gray-400">Sudah punya akun? <button id="switch-to-login" class="font-semibold text-amber-400 hover:underline">Masuk di sini</button></p>
        </div>
        <!-- Register Success -->
        <div id="register-success" class="auth-form text-center bg-slate-900 p-8 rounded-xl shadow-2xl w-full max-w-md hidden">
            <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
            <h2 class="text-2xl font-bold text-white">Pendaftaran Berhasil!</h2>
            <p class="text-gray-400 mt-2">Silakan masuk menggunakan akun baru Anda.</p>
            <button id="success-login-btn" class="mt-6 w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg text-lg transition duration-300">Lanjut Masuk</button>
        </div>
    </section>

    <!-- Main Content (Logged In) -->
    <div id="main-content" class="hidden">
        <main>
            <!-- Dashboard/Hero Section -->
            <section class="hero-bg min-h-[60vh] flex items-center justify-center text-center px-4">
                <div class="bg-black/50 p-6 sm:p-8 rounded-xl">
                    <h1 class="text-3xl sm:text-4xl md:text-6xl font-black text-white uppercase tracking-wider">
                        Kemenangan <span class="text-amber-400">Besar</span> Menanti
                    </h1>
                    <p class="mt-4 text-base md:text-xl text-gray-300 max-w-2xl mx-auto">
                        Selamat datang, <span id="dashboard-username" class="font-bold text-white"></span>! Jelajahi berbagai permainan seru dan raih kesempatan emas Anda.
                    </p>
                    <a href="#mode-selection" class="mt-8 inline-block bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-full text-base sm:text-lg uppercase transition duration-300 transform hover:scale-105">
                        Mulai Bermain
                    </a>
                </div>
            </section>
            
            <!-- Mode Selection Section -->
            <section id="mode-selection" class="container mx-auto px-4 py-16 text-center">
                 <h2 class="text-3xl font-bold text-center mb-10">Pilih Mode Permainan</h2>
                <div class="mt-8 flex flex-col md:flex-row justify-center items-center gap-6">
                    <div id="play-demo-btn" class="w-full md:w-80 p-8 bg-slate-800 rounded-xl border border-amber-500 cursor-pointer transition-transform transform hover:scale-105">
                        <i data-lucide="play-circle" class="w-16 h-16 text-amber-400 mx-auto"></i>
                        <h2 class="text-2xl font-bold mt-4">Main Demo</h2>
                        <p class="text-gray-400 mt-1">Coba semua permainan dengan saldo virtual.</p>
                    </div>
                     <div class="w-full md:w-80 p-8 bg-slate-800 rounded-xl border border-slate-700 opacity-50 cursor-not-allowed">
                        <i data-lucide="credit-card" class="w-16 h-16 text-slate-500 mx-auto"></i>
                        <h2 class="text-2xl font-bold mt-4">Deposit</h2>
                        <p class="text-slate-500 mt-1">(Fitur ini sedang dalam pengembangan)</p>
                    </div>
                </div>
            </section>

            <!-- Game Selection Section (Hidden by default) -->
            <section id="games" class="container mx-auto px-4 py-16 hidden">
                <h2 class="text-3xl font-bold text-center mb-10">Pilih Permainan Favorit Anda</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-6">
                    <!-- Game Cards will be inserted here by JS -->
                </div>
            </section>
        </main>
        <!-- Footer -->
        <footer class="bg-slate-900 border-t border-slate-700 mt-12">
            <div class="container mx-auto px-4 py-6 text-center text-gray-400">
                <p>&copy; 2025 Galaxy Casino. Semua game hanya untuk tujuan demonstrasi.</p>
            </div>
        </footer>
    </div>

    <!-- Game Modals Container -->
    <div id="modal-container" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] hidden p-4 overflow-y-auto">
        <!-- All game modals will be injected here from JS Templates -->
    </div>
    
    <!-- Refill Notification -->
    <div id="refill-notification" class="hidden fixed bottom-5 right-5 bg-green-600 text-white py-3 px-5 rounded-lg shadow-lg transition-opacity duration-500 z-[200]">
        Saldo Anda telah diisi ulang sebesar 5.000!
    </div>

    <!-- SCRIPT UTAMA -->
    <script>
        // SCRIPT UTAMA DIMULAI DI SINI
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL VARIABLES & DATA ---
            let currentUser = null;
            let balanceCheckInterval = null;
            const MIN_BET = 3000;

            const gamesData = [
                { id: 'slot', name: 'Slot Machine', icon: 'gem' },
                { id: 'dice', name: 'Dice / SicBo', icon: 'dice-5' },
                { id: 'blackjack', name: 'Blackjack', icon: 'spade' },
                { id: 'keno', name: 'Keno', icon: 'app-window' },
                { id: 'crash', name: 'Crash Game', icon: 'trending-up' },
                { id: 'trading', name: 'Trading', icon: 'line-chart' },
                { id: 'roulette', name: 'Roulette', icon: 'circle-dashed' },
                { id: 'baccarat', name: 'Baccarat', icon: 'user-square-2' },
                { id: 'poker', name: 'Video Poker', icon: 'layers' },
                { id: 'hilo', name: 'Hi-Lo Cards', icon: 'arrow-up-down' },
                { id: 'scratch', name: 'Scratch Cards', icon: 'sparkles' },
                { id: 'coinflip', name: 'Coin Flip', icon: 'circle-dollar-sign' },
                { id: 'wheel', name: 'Wheel of Fortune', icon: 'disc' },
                { id: 'guessnumber', name: 'Tebak Angka', icon: 'hash' }
            ];
            const modalTemplates = {};

            // --- UI ELEMENT SELECTORS ---
            const authSection = document.getElementById('auth-section');
            const mainContent = document.getElementById('main-content');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const registerSuccess = document.getElementById('register-success');
            const authButtons = document.getElementById('auth-buttons');
            const userSession = document.getElementById('user-session');
            const gamesSection = document.getElementById('games');
            const modalContainer = document.getElementById('modal-container');
            const playDemoBtn = document.getElementById('play-demo-btn');
            
            // --- AUTH & UI TOGGLING FUNCTIONS ---
            const showForm = (formToShow) => {
                authSection.classList.remove('hidden');
                [loginForm, registerForm, registerSuccess].forEach(form => form.classList.add('hidden'));
                if (formToShow) formToShow.classList.remove('hidden');
            };

            const updateUIForLogin = () => {
                authSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                authButtons.classList.add('hidden');
                userSession.classList.remove('hidden');
                userSession.classList.add('flex');
                document.getElementById('username-display').textContent = currentUser.username;
                document.getElementById('dashboard-username').textContent = currentUser.username;
                updateBalanceDisplay();
                
                checkAndRefillBalance(); // Check once on login
                if (balanceCheckInterval) clearInterval(balanceCheckInterval);
                balanceCheckInterval = setInterval(checkAndRefillBalance, 60 * 1000); // Check every minute
            };

            const updateUIForLogout = () => {
                mainContent.classList.add('hidden');
                gamesSection.classList.add('hidden');
                authButtons.classList.remove('hidden');
                userSession.classList.add('hidden');
                userSession.classList.remove('flex');
                if (balanceCheckInterval) clearInterval(balanceCheckInterval);
                showForm(loginForm);
            };
            
            const updateBalanceDisplay = () => {
                 if(currentUser) {
                    const formattedBalance = currentUser.balance.toLocaleString('id-ID');
                    document.getElementById('balance-display').textContent = formattedBalance;
                    const openBalanceEl = modalContainer.querySelector('.game-balance.active-balance');
                    if (openBalanceEl) openBalanceEl.textContent = formattedBalance;
                 }
            };
            
            const showRefillNotification = () => {
                const notification = document.getElementById('refill-notification');
                notification.classList.remove('hidden');
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, 5000); // Hide after 5 seconds
            };

            const checkAndRefillBalance = () => {
                if (!currentUser || !currentUser.lowBalanceTimestamp) return;

                const thirtyMinutes = 30 * 60 * 1000;
                const timeElapsed = Date.now() - currentUser.lowBalanceTimestamp;

                if (currentUser.balance < MIN_BET && timeElapsed >= thirtyMinutes) {
                    currentUser.balance += 5000;
                    delete currentUser.lowBalanceTimestamp;
                    saveUserData();
                    showRefillNotification();
                }
            };

            // --- CORE AUTH LOGIC & VALIDATION ---
            const checkSession = () => {
                const loggedIn = localStorage.getItem('galaxyCasinoSession');
                const currentUsername = localStorage.getItem('galaxyCasinoCurrentUser');
                if (loggedIn === 'true' && currentUsername) {
                    let users = JSON.parse(localStorage.getItem('galaxyCasinoUsers')) || [];
                    currentUser = users.find(user => user.username === currentUsername);
                    if (currentUser) {
                        updateUIForLogin();
                    } else {
                        handleLogout();
                    }
                } else {
                    updateUIForLogout();
                }
            };

            const handleRegister = (e) => {
                e.preventDefault();
                const username = document.getElementById('register-username').value.trim();
                const phone = document.getElementById('register-phone').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const errorEl = document.getElementById('register-error');
                errorEl.textContent = ''; 

                let users = JSON.parse(localStorage.getItem('galaxyCasinoUsers')) || [];
                
                if (users.length >= 2) {
                    errorEl.textContent = 'Hanya 2 akun yang diizinkan per perangkat.';
                    return;
                }

                if (users.some(user => user.username === username)) {
                    errorEl.textContent = 'Username sudah digunakan.';
                    return;
                }

                if (username.length < 5) {
                    errorEl.textContent = 'Username harus minimal 5 karakter.'; return;
                }
                if (!/^\d{10,13}$/.test(phone)) {
                    errorEl.textContent = 'Format nomor HP tidak valid (10-13 digit angka).'; return;
                }
                if (!/^\S+@\S+\.\S+$/.test(email)) {
                    errorEl.textContent = 'Format email tidak valid.'; return;
                }
                if (password.length < 8) {
                    errorEl.textContent = 'Password harus minimal 8 karakter.'; return;
                }

                const newUser = { username, phone, email, password, balance: 50000 };
                users.push(newUser);
                localStorage.setItem('galaxyCasinoUsers', JSON.stringify(users));
                showForm(registerSuccess);
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const errorEl = document.getElementById('login-error');
                
                let users = JSON.parse(localStorage.getItem('galaxyCasinoUsers')) || [];
                const foundUser = users.find(user => user.username === username && user.password === password);

                if (foundUser) {
                    localStorage.setItem('galaxyCasinoSession', 'true');
                    localStorage.setItem('galaxyCasinoCurrentUser', username); 
                    currentUser = foundUser;
                    updateUIForLogin();
                    errorEl.textContent = '';
                } else {
                    errorEl.textContent = 'Username atau password salah.';
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('galaxyCasinoSession');
                localStorage.removeItem('galaxyCasinoCurrentUser');
                currentUser = null;
                updateUIForLogout();
            };

            const saveUserData = () => {
                if (currentUser) {
                    if (currentUser.balance < 0) {
                        currentUser.balance = 0;
                    }
                    
                    let users = JSON.parse(localStorage.getItem('galaxyCasinoUsers')) || [];
                    const userIndex = users.findIndex(user => user.username === currentUser.username);

                    if (currentUser.balance < MIN_BET) {
                        if (!currentUser.lowBalanceTimestamp) {
                            currentUser.lowBalanceTimestamp = Date.now();
                        }
                    } else {
                        delete currentUser.lowBalanceTimestamp;
                    }

                    if (userIndex !== -1) {
                        users[userIndex] = currentUser;
                        localStorage.setItem('galaxyCasinoUsers', JSON.stringify(users));
                    }
                    updateBalanceDisplay();
                }
            };

            // --- EVENT LISTENERS ---
            document.getElementById('show-login-btn').addEventListener('click', () => showForm(loginForm));
            document.getElementById('show-register-btn').addEventListener('click', () => showForm(registerForm));
            document.getElementById('switch-to-register').addEventListener('click', () => showForm(registerForm));
            document.getElementById('switch-to-login').addEventListener('click', () => showForm(loginForm));
            document.getElementById('success-login-btn').addEventListener('click', () => showForm(loginForm));
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('login-form-submit').addEventListener('submit', handleLogin);
            document.getElementById('register-form-submit').addEventListener('submit', handleRegister);
            playDemoBtn.addEventListener('click', () => {
                gamesSection.classList.remove('hidden');
                gamesSection.scrollIntoView({ behavior: 'smooth' });
            });
            
            const handleCanvasResize = () => {
                const canvases = ['wheelCanvas', 'crash-canvas', 'trading-canvas'];
                canvases.forEach(id => {
                    const canvas = document.getElementById(id);
                    if (canvas && canvas.offsetParent !== null) {
                        const container = canvas.parentElement;
                        canvas.width = container.clientWidth;
                        canvas.height = container.clientHeight;
                        if(window[`draw_${id.replace('-', '')}`]) window[`draw_${id.replace('-', '')}`]();
                    }
                });
            };

            // --- GAME & MODAL INITIALIZATION ---
            const initializeApp = () => {
                const gameGrid = gamesSection.querySelector('.grid');
                gameGrid.innerHTML = gamesData.map(game => `
                    <div class="game-card" data-game="${game.id}">
                        <i data-lucide="${game.icon}" class="w-10 h-10 sm:w-12 sm:h-12 text-amber-400"></i>
                        <h3 class="font-bold mt-2 text-xs sm:text-base">${game.name}</h3>
                    </div>
                `).join('');
                
                 const baseCardClasses = "relative bg-slate-800 rounded-xl p-4 flex flex-col items-center justify-center text-center aspect-square cursor-pointer transform transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl hover:shadow-amber-500/20";
                document.querySelectorAll('.game-card').forEach(card => {
                    card.className = baseCardClasses;
                    card.addEventListener('click', () => openGameModal(card.dataset.game));
                });
                
                modalContainer.innerHTML = Object.values(modalTemplates).join('');
                
                modalContainer.addEventListener('click', (e) => {
                     if (e.target.classList.contains('close-modal') || e.target === modalContainer) {
                        closeModal();
                    }
                });

                attachGameLogicListeners();

                lucide.createIcons();
                checkSession();

                window.addEventListener('resize', handleCanvasResize);
            };
            
            const openGameModal = (gameId) => {
                document.querySelectorAll('.modal-content').forEach(m => {
                    m.classList.add('hidden');
                    const balanceEl = m.querySelector('.game-balance');
                    if(balanceEl) balanceEl.classList.remove('active-balance');
                });

                const modal = document.getElementById(`modal-${gameId}`);
                if (modal) {
                    modalContainer.classList.remove('hidden');
                    modal.classList.remove('hidden');
                    
                    if (window[`setup_${gameId}`]) {
                        window[`setup_${gameId}`]();
                    }
                    
                    if (['wheel', 'crash', 'trading'].includes(gameId)) {
                        setTimeout(handleCanvasResize, 50); // Delay to allow modal animation
                    }
                    
                    const balanceEl = modal.querySelector('.game-balance');
                    if(balanceEl) {
                        balanceEl.textContent = currentUser.balance.toLocaleString('id-ID');
                        balanceEl.classList.add('active-balance');
                    }
                    lucide.createIcons();
                }
            };
            
            let crashGameLoopId = null;
            const closeModal = () => {
                modalContainer.classList.add('hidden');
                if (crashGameLoopId) {
                    cancelAnimationFrame(crashGameLoopId);
                    crashGameLoopId = null;
                }
            };

            // --- GAME LOGIC IMPLEMENTATIONS ---
            const betInputHTML = (defaultValue = MIN_BET) => `
                <div class="flex flex-col items-center space-y-2 mt-4">
                    <label class="font-semibold">Jumlah Taruhan:</label>
                    <input type="number" class="bet-input bg-slate-700 text-white text-center rounded-lg p-2 w-40" value="${defaultValue}" min="${MIN_BET}" step="100">
                </div>`;
            const gameBalanceHTML = `<p class="text-center mt-2">Saldo Anda: <span class="game-balance font-bold text-amber-400"></span></p>`;
            const gameResultHTML = (id, height = 'h-8') => `<p id="${id}" class="text-center ${height} my-4 font-bold text-lg sm:text-xl"></p>`;
            const modalHeader = (title, icon) => `
                <button class="close-modal absolute top-3 right-4 text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
                <h2 class="text-xl sm:text-2xl font-bold text-amber-400 mb-4 text-center flex items-center justify-center gap-2"><i data-lucide="${icon}"></i> ${title}</h2>
            `;
            
            // --- MODAL TEMPLATES (NOW WITH FULL HTML) ---
            Object.assign(modalTemplates, {
                slot: `
                <div id="modal-slot" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-md hidden relative">
                    ${modalHeader('Slot Machine', 'gem')}
                    <div class="bg-slate-900/50 p-4 rounded-lg flex justify-center items-center space-x-4 h-32 overflow-hidden">
                        <div id="slot-reel1" class="text-5xl">💎</div>
                        <div id="slot-reel2" class="text-5xl">💎</div>
                        <div id="slot-reel3" class="text-5xl">💎</div>
                    </div>
                    ${gameResultHTML('slot-result')}
                    ${betInputHTML()}
                    ${gameBalanceHTML}
                    <button id="slot-spin-btn" class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300">Spin</button>
                </div>`,
                dice: `
                <div id="modal-dice" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-md hidden relative">
                     ${modalHeader('Dice / SicBo', 'dice-5')}
                     <div class="bg-slate-900/50 p-4 rounded-lg flex justify-center items-center space-x-4 h-24">
                        <div id="dice-1" class="text-5xl">⚅</div>
                        <div id="dice-2" class="text-5xl">⚅</div>
                        <div id="dice-3" class="text-5xl">⚅</div>
                    </div>
                    ${gameResultHTML('dice-result')}
                    <p class="text-center text-gray-400">Pilih taruhan Anda:</p>
                    <div class="flex justify-center space-x-4 mt-2">
                        <button id="dice-bet-small" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-6 rounded-lg w-1/2">Kecil (3-10)</button>
                        <button id="dice-bet-big" class="bg-red-600 hover:bg-red-700 font-bold py-2 px-6 rounded-lg w-1/2">Besar (11-18)</button>
                    </div>
                    ${betInputHTML()}
                    ${gameBalanceHTML}
                </div>`,
                blackjack: `
                <div id="modal-blackjack" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-lg hidden relative">
                    ${modalHeader('Blackjack', 'spade')}
                    <div class="bg-green-800/50 p-4 rounded-lg min-h-[250px] space-y-4"><div><h3 class="font-bold">Dealer (<span id="dealer-score">0</span>)</h3><div id="dealer-cards" class="flex space-x-2 mt-1 h-20"></div></div><div><h3 class="font-bold">Pemain (<span id="player-score">0</span>)</h3><div id="player-cards" class="flex space-x-2 mt-1 h-20"></div></div></div>
                    ${gameResultHTML('blackjack-result')}
                    <div id="blackjack-controls" class="flex justify-center space-x-4"><button id="bj-hit" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-6 rounded-lg">Hit</button><button id="bj-stand" class="bg-yellow-600 hover:bg-yellow-700 font-bold py-2 px-6 rounded-lg">Stand</button></div>
                    <button id="bj-new-game" class="hidden w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-2 px-6 rounded-lg">Game Baru</button>
                    ${betInputHTML()}
                    ${gameBalanceHTML}
                </div>`,
                keno: `
                <div id="modal-keno" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-3xl hidden relative">
                    ${modalHeader('Keno', 'app-window')}
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="w-full md:w-2/3">
                            <div id="keno-grid" class="grid grid-cols-10 gap-1"></div>
                            <p class="text-center text-sm text-gray-400 mt-2">Pilih 2 hingga 10 angka.</p>
                        </div>
                        <div class="w-full md:w-1/3 bg-slate-900/50 p-4 rounded-lg">
                            <h3 class="font-bold text-lg text-amber-400 text-center mb-2">Tabel Payout</h3>
                            <div id="keno-payout-preview" class="text-sm space-y-1">Pilih jumlah angka untuk melihat payout.</div>
                        </div>
                    </div>
                    ${gameResultHTML('keno-result')}
                    <div class="flex flex-col sm:flex-row gap-2 mt-4">
                        <button id="keno-draw-btn" class="w-full sm:w-2/3 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg uppercase transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Mulai Draw</button>
                        <button id="keno-reset-btn" class="w-full sm:w-1/3 bg-slate-600 hover:bg-slate-700 font-bold py-2 px-6 rounded-lg">Pilih Ulang</button>
                    </div>
                    ${betInputHTML()}
                    ${gameBalanceHTML}
                </div>`,
                crash: `
                <div id="modal-crash" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-lg hidden relative">
                    ${modalHeader('Crash Game', 'trending-up')}
                    <div class="relative bg-slate-900 rounded-lg h-64 p-2">
                        <canvas id="crash-canvas"></canvas>
                        <div id="crash-multiplier-display" class="absolute inset-0 flex items-center justify-center text-5xl font-black text-white" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);">1.00x</div>
                    </div>
                    ${gameResultHTML('crash-result')}
                    <button id="crash-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300">Mulai</button>
                    ${betInputHTML()}
                    ${gameBalanceHTML}
                </div>`,
                 coinflip: `
                <div id="modal-coinflip" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-md hidden relative">
                    ${modalHeader('Coin Flip', 'circle-dollar-sign')}
                    <div class="flex justify-center items-center h-32">
                        <div id="coinflip-coin" class="text-7xl">🪙</div>
                    </div>
                    ${gameResultHTML('coinflip-result')}
                    <div class="flex justify-center space-x-4 mt-2">
                        <button id="coinflip-heads" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-6 rounded-lg w-1/2">Kepala</button>
                        <button id="coinflip-tails" class="bg-red-600 hover:bg-red-700 font-bold py-2 px-6 rounded-lg w-1/2">Ekor</button>
                    </div>
                    ${betInputHTML()}
                    ${gameBalanceHTML}
                </div>`,
                roulette: `
                <div id="modal-roulette" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-lg hidden relative">
                    ${modalHeader('Roulette', 'circle-dashed')}
                    <div class="bg-slate-900/50 rounded-full w-48 h-48 mx-auto flex items-center justify-center mb-4">
                        <span id="roulette-result-number" class="text-5xl font-bold">0</span>
                    </div>
                    ${gameResultHTML('roulette-result-text')}
                    <div class="grid grid-cols-2 gap-2">
                        <button class="roulette-bet-btn bg-red-700 hover:bg-red-800 font-bold py-3 rounded-lg" data-bet="red">Merah</button>
                        <button class="roulette-bet-btn bg-slate-900 hover:bg-slate-950 text-white font-bold py-3 rounded-lg" data-bet="black">Hitam</button>
                        <button class="roulette-bet-btn bg-green-700 hover:bg-green-800 font-bold py-3 rounded-lg" data-bet="even">Genap</button>
                        <button class="roulette-bet-btn bg-green-700 hover:bg-green-800 font-bold py-3 rounded-lg" data-bet="odd">Ganjil</button>
                    </div>
                    ${betInputHTML()}
                    ${gameBalanceHTML}
                </div>`,
                baccarat: `
                <div id="modal-baccarat" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-lg hidden relative">
                     ${modalHeader('Baccarat', 'user-square-2')}
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <h3 class="font-bold text-lg">PLAYER (<span id="baccarat-player-score">0</span>)</h3>
                            <div id="baccarat-player-cards" class="flex justify-center space-x-2 mt-2 h-20"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">BANKER (<span id="baccarat-banker-score">0</span>)</h3>
                            <div id="baccarat-banker-cards" class="flex justify-center space-x-2 mt-2 h-20"></div>
                        </div>
                    </div>
                     ${gameResultHTML('baccarat-result')}
                     <div class="grid grid-cols-3 gap-2 mt-4">
                        <button class="baccarat-bet-btn bg-blue-700 hover:bg-blue-800 font-bold py-3 rounded-lg" data-bet="player">Player</button>
                        <button class="baccarat-bet-btn bg-gray-600 hover:bg-gray-700 font-bold py-3 rounded-lg" data-bet="tie">Tie</button>
                        <button class="baccarat-bet-btn bg-red-700 hover:bg-red-800 font-bold py-3 rounded-lg" data-bet="banker">Banker</button>
                     </div>
                     ${betInputHTML()}
                     ${gameBalanceHTML}
                </div>`,
                poker: `
                <div id="modal-poker" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-2xl hidden relative">
                    ${modalHeader('Video Poker', 'layers')}
                    <div id="poker-hand" class="flex justify-center space-x-1 sm:space-x-2 mt-2 h-[100px]"></div>
                    <div class="text-center mt-2 h-4 text-xs text-amber-400">Klik kartu untuk menahan (Hold)</div>
                    ${gameResultHTML('poker-result')}
                    <div class="flex flex-col sm:flex-row gap-2 mt-4">
                        <button id="poker-deal-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">DEAL</button>
                        <button id="poker-draw-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg hidden">DRAW</button>
                    </div>
                     ${betInputHTML()}
                     ${gameBalanceHTML}
                </div>`,
                hilo: `
                <div id="modal-hilo" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-md hidden relative">
                    ${modalHeader('Hi-Lo Cards', 'arrow-up-down')}
                    <div class="flex justify-around items-center h-32">
                        <div>
                            <p class="text-center font-bold">Kartu Saat Ini</p>
                            <div id="hilo-current-card" class="card"></div>
                        </div>
                        <div>
                             <p class="text-center font-bold">Kartu Berikutnya</p>
                            <div id="hilo-next-card" class="card hidden-card">?</div>
                        </div>
                    </div>
                    ${gameResultHTML('hilo-result')}
                     <div class="flex justify-center space-x-4 mt-2">
                        <button id="hilo-high-btn" class="bg-green-600 hover:bg-green-700 font-bold py-2 px-6 rounded-lg w-1/2">Lebih Tinggi</button>
                        <button id="hilo-low-btn" class="bg-red-600 hover:bg-red-700 font-bold py-2 px-6 rounded-lg w-1/2">Lebih Rendah</button>
                    </div>
                    ${betInputHTML()}
                    ${gameBalanceHTML}
                </div>`,
                scratch: `
                <div id="modal-scratch" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-md hidden relative">
                     ${modalHeader('Scratch Cards', 'sparkles')}
                    <div id="scratch-grid" class="grid grid-cols-3 gap-2 bg-slate-900 p-2 rounded-lg aspect-square"></div>
                     ${gameResultHTML('scratch-result')}
                    <button id="scratch-new-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">Beli Kartu Baru</button>
                     ${betInputHTML()}
                     ${gameBalanceHTML}
                </div>`,
                wheel: `
                <div id="modal-wheel" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-lg hidden relative">
                     ${modalHeader('Wheel of Fortune', 'disc')}
                    <div class="relative flex justify-center items-center my-4">
                        <div class="absolute text-amber-400 text-4xl top-[-20px] z-10">▼</div>
                        <div class="canvas-container">
                           <canvas id="wheelCanvas"></canvas>
                        </div>
                    </div>
                     ${gameResultHTML('wheel-result')}
                    <button id="wheel-spin-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">PUTAR</button>
                     ${betInputHTML()}
                     ${gameBalanceHTML}
                </div>`,
                guessnumber: `
                <div id="modal-guessnumber" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-md hidden relative">
                    ${modalHeader('Tebak Angka (1-100)', 'hash')}
                    <div id="guessnumber-start-screen">
                        <p class="text-center my-4">Pasang taruhan untuk memulai. Anda punya 3 kesempatan untuk menebak angka rahasia.</p>
                        ${betInputHTML()}
                        <button id="guessnumber-start-btn" class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">PASANG TARUHAN & MULAI</button>
                    </div>
                    <div id="guessnumber-game-screen" class="hidden">
                        <div class="flex flex-col items-center space-y-2">
                            <label for="guessnumber-input" class="font-semibold">Masukkan tebakan Anda:</label>
                            <input type="number" id="guessnumber-input" class="bg-slate-700 text-white text-center rounded-lg p-2 w-40" min="1" max="100">
                            <button id="guessnumber-guess-btn" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-8 rounded-lg mt-2">TEBAK</button>
                        </div>
                        <p class="text-center mt-2 text-amber-300">Sisa Kesempatan: <span id="guessnumber-attempts">3</span></p>
                    </div>
                    ${gameResultHTML('guessnumber-result')}
                    ${gameBalanceHTML}
                </div>`,
                trading: `
                <div id="modal-trading" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-[95%] sm:w-full max-w-2xl hidden relative">
                    ${modalHeader('Trading', 'line-chart')}
                    <div id="trading-start-screen">
                        <p class="text-center my-4">Prediksi apakah harga akan NAIK atau TURUN dalam 20 detik ke depan untuk memenangkan hadiah!</p>
                        ${betInputHTML()}
                        <button id="trading-start-btn" class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">MULAI TRADING</button>
                    </div>
                    <div id="trading-game-screen" class="hidden">
                        <div class="relative bg-slate-900 rounded-lg h-64 p-2">
                            <canvas id="trading-canvas"></canvas>
                            <div id="trading-info-overlay" class="absolute top-2 right-2 bg-black/50 p-2 rounded text-right text-sm">
                                <p>Waktu: <span id="trading-timer" class="font-bold text-amber-300">20</span>s</p>
                                <p>Harga: <span id="trading-price" class="font-bold text-white">100.00</span></p>
                            </div>
                        </div>
                        <div id="trading-controls" class="flex justify-center space-x-4 mt-4">
                            <button id="trading-up-btn" class="w-1/2 bg-green-600 hover:bg-green-700 font-bold py-3 rounded-lg flex items-center justify-center gap-2">Naik <i data-lucide="trending-up"></i></button>
                            <button id="trading-down-btn" class="w-1/2 bg-red-600 hover:bg-red-700 font-bold py-3 rounded-lg flex items-center justify-center gap-2">Turun <i data-lucide="trending-down"></i></button>
                        </div>
                    </div>
                    ${gameResultHTML('trading-result')}
                    ${gameBalanceHTML}
                </div>`
            });
            
            // --- ATTACH ALL GAME LOGIC LISTENERS ---
            function attachGameLogicListeners() {
                // [FIXED] New helper function for validating bets
                const getValidBet = (modalSelector) => {
                    const betInput = document.querySelector(`${modalSelector} .bet-input`);
                    const resultEl = document.querySelector(`${modalSelector} p[id$="-result"], ${modalSelector} p[id$="-result-text"]`);

                    if (!betInput || !resultEl) {
                        console.error("Elemen taruhan atau hasil tidak ditemukan untuk", modalSelector);
                        return null;
                    }

                    const betValue = parseInt(betInput.value, 10);

                    if (isNaN(betValue) || betValue <= 0) {
                        resultEl.textContent = `Harap masukkan jumlah taruhan yang valid.`;
                        return null;
                    }
                    
                    if (betValue < MIN_BET) {
                        resultEl.textContent = `Taruhan minimal adalah ${MIN_BET.toLocaleString('id-ID')}.`;
                        return null;
                    }

                    if (currentUser.balance < betValue) {
                        resultEl.textContent = "Saldo tidak cukup!";
                        return null;
                    }
                    
                    resultEl.textContent = ''; // Clear previous error message
                    return betValue;
                };

                // Shared card logic
                const suits = ['♥', '♦', '♣', '♠'];
                const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
                
                const createDeck = () => {
                    return suits.flatMap(suit => values.map(value => ({ suit, value })));
                };

                const shuffleDeck = (deck) => {
                    for (let i = deck.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [deck[i], deck[j]] = [deck[j], deck[i]];
                    }
                    return deck;
                };

                const getCardValue = (card) => {
                    if (['J', 'Q', 'K'].includes(card.value)) return 10;
                    if (card.value === 'A') return 11;
                    return parseInt(card.value);
                };
                
                const createCardElement = (card, isHidden = false) => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'card w-1/6 sm:w-1/5'; // Responsive card width
                    if (isHidden) {
                        cardEl.classList.add('hidden-card');
                        cardEl.innerHTML = '';
                    } else {
                        cardEl.innerHTML = `${card.value}<br>${card.suit}`;
                        if (['♥', '♦'].includes(card.suit)) {
                            cardEl.classList.add('red');
                        }
                    }
                    return cardEl;
                };
                
                // --- SLOT MACHINE LOGIC ---
                window.setup_slot = () => {
                    document.getElementById('slot-result').textContent = '';
                };
                document.getElementById('slot-spin-btn').addEventListener('click', () => {
                    const bet = getValidBet('#modal-slot');
                    if (bet === null) return;
                    
                    const resultEl = document.getElementById('slot-result');
                    const spinBtn = document.getElementById('slot-spin-btn');
                    
                    currentUser.balance -= bet;
                    saveUserData();
                    resultEl.textContent = "";
                    spinBtn.disabled = true;
                    const reels = [document.getElementById('slot-reel1'), document.getElementById('slot-reel2'), document.getElementById('slot-reel3')];
                    const symbols = ['💎', '🍒', '🍋', '🔔', '💰', '⭐'];
                    let finalResults = [];

                    reels.forEach((reel, i) => {
                        setTimeout(() => {
                            const interval = setInterval(() => { reel.textContent = symbols[Math.floor(Math.random() * symbols.length)]; }, 100);
                            setTimeout(() => {
                                clearInterval(interval);
                                const finalSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                                reel.textContent = finalSymbol;
                                finalResults.push(finalSymbol);
                                if (i === reels.length - 1) { // Last reel
                                    if (finalResults[0] === finalResults[1] && finalResults[1] === finalResults[2]) {
                                        const winnings = bet * 10;
                                        currentUser.balance += winnings;
                                        resultEl.textContent = `JACKPOT! Anda menang ${winnings.toLocaleString('id-ID')}!`;
                                    } else {
                                        resultEl.textContent = "Coba lagi!";
                                    }
                                    saveUserData();
                                    spinBtn.disabled = false;
                                }
                            }, 1000 + i * 500);
                        }, i * 200);
                    });
                });

                // --- DICE/SICBO LOGIC ---
                window.setup_dice = () => {
                     document.getElementById('dice-result').textContent = '';
                };
                const handleDiceBet = (betType) => {
                    const bet = getValidBet('#modal-dice');
                    if (bet === null) return;

                    currentUser.balance -= bet;
                    const resultEl = document.getElementById('dice-result');
                    const diceEmojis = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'];
                    const d1 = Math.floor(Math.random() * 6) + 1;
                    const d2 = Math.floor(Math.random() * 6) + 1;
                    const d3 = Math.floor(Math.random() * 6) + 1;
                    const total = d1 + d2 + d3;
                    document.getElementById('dice-1').textContent = diceEmojis[d1 - 1];
                    document.getElementById('dice-2').textContent = diceEmojis[d2 - 1];
                    document.getElementById('dice-3').textContent = diceEmojis[d3 - 1];
                    const resultType = (total >= 3 && total <= 10) ? 'small' : 'big';
                    if (betType === resultType) {
                        const winnings = bet * 2;
                        currentUser.balance += winnings;
                        resultEl.textContent = `Total ${total}: Anda menang ${winnings.toLocaleString('id-ID')}!`;
                    } else {
                        resultEl.textContent = `Total ${total}: Anda kalah.`;
                    }
                    saveUserData();
                };
                document.getElementById('dice-bet-small').addEventListener('click', () => handleDiceBet('small'));
                document.getElementById('dice-bet-big').addEventListener('click', () => handleDiceBet('big'));

                // --- BLACKJACK LOGIC ---
                let bjDeck, bjPlayerHand, bjDealerHand, bjPlayerScore, bjDealerScore, bjBet;
                const bjResultEl = document.getElementById('blackjack-result');
                const startBlackjack = () => {
                    bjBet = getValidBet('#modal-blackjack');
                    if (bjBet === null) return;
                    
                    currentUser.balance -= bjBet;
                    saveUserData();

                    bjDeck = shuffleDeck(createDeck());
                    bjPlayerHand = [bjDeck.pop(), bjDeck.pop()];
                    bjDealerHand = [bjDeck.pop(), bjDeck.pop()];
                    
                    document.getElementById('blackjack-controls').classList.remove('hidden');
                    document.getElementById('bj-new-game').classList.add('hidden');
                    document.querySelector('#modal-blackjack .bet-input').parentElement.classList.add('hidden');
                    bjResultEl.textContent = '';
                    
                    renderBlackjackHands();
                    checkBlackjack();
                };
                const renderBlackjackHands = (revealDealer = false) => {
                    const playerHandEl = document.getElementById('player-cards');
                    const dealerHandEl = document.getElementById('dealer-cards');
                    playerHandEl.innerHTML = '';
                    dealerHandEl.innerHTML = '';
                    bjPlayerHand.forEach(card => playerHandEl.appendChild(createCardElement(card)));
                    bjDealerHand.forEach((card, i) => {
                        dealerHandEl.appendChild(createCardElement(card, i === 0 && !revealDealer));
                    });
                    bjPlayerScore = calculateHandScore(bjPlayerHand);
                    bjDealerScore = calculateHandScore(bjDealerHand, revealDealer);
                    document.getElementById('player-score').textContent = bjPlayerScore;
                    document.getElementById('dealer-score').textContent = revealDealer ? bjDealerScore : getCardValue(bjDealerHand[1]);
                };
                const calculateHandScore = (hand, countAll = true) => {
                    let score = 0;
                    let aces = 0;
                    hand.forEach((card, i) => {
                        if (!countAll && i === 0) return;
                        score += getCardValue(card);
                        if (card.value === 'A') aces++;
                    });
                    while (score > 21 && aces > 0) {
                        score -= 10;
                        aces--;
                    }
                    return score;
                };
                const checkBlackjack = () => {
                    if (bjPlayerScore === 21) {
                        endBlackjack('Pemain Blackjack! Anda menang!', bjBet * 2.5);
                    }
                };
                const endBlackjack = (message, winnings = 0) => {
                    renderBlackjackHands(true);
                    currentUser.balance += winnings;
                    bjResultEl.textContent = message;
                    saveUserData();
                    document.getElementById('blackjack-controls').classList.add('hidden');
                    document.getElementById('bj-new-game').classList.remove('hidden');
                    document.querySelector('#modal-blackjack .bet-input').parentElement.classList.remove('hidden');
                };
                document.getElementById('bj-hit').addEventListener('click', () => {
                    bjPlayerHand.push(bjDeck.pop());
                    renderBlackjackHands();
                    if (bjPlayerScore > 21) {
                        endBlackjack('Bust! Anda kalah.');
                    }
                });
                document.getElementById('bj-stand').addEventListener('click', () => {
                    renderBlackjackHands(true);
                    while (bjDealerScore < 17) {
                        bjDealerHand.push(bjDeck.pop());
                        bjDealerScore = calculateHandScore(bjDealerHand);
                    }
                    renderBlackjackHands(true);
                    if (bjDealerScore > 21 || bjPlayerScore > bjDealerScore) {
                        endBlackjack('Anda Menang!', bjBet * 2);
                    } else if (bjDealerScore > bjPlayerScore) {
                        endBlackjack('Dealer Menang.');
                    } else {
                        endBlackjack('Push (Seri).', bjBet);
                    }
                });
                window.setup_blackjack = () => {
                    startBlackjack();
                }
                document.getElementById('bj-new-game').addEventListener('click', startBlackjack);

                // --- KENO LOGIC (REWORKED & FIXED) ---
                let kenoSelected = [];
                const kenoGrid = document.getElementById('keno-grid');
                const kenoDrawBtn = document.getElementById('keno-draw-btn');
                const kenoResetBtn = document.getElementById('keno-reset-btn');
                const kenoResultEl = document.getElementById('keno-result');
                const kenoPayoutPreviewEl = document.getElementById('keno-payout-preview');
                const kenoBetInput = document.querySelector('#modal-keno .bet-input');
                
                const kenoPayouts = {
                    2: { 2: 9 },
                    3: { 2: 1, 3: 16 },
                    4: { 2: 1, 3: 4, 4: 80 },
                    5: { 3: 2, 4: 10, 5: 250 },
                    6: { 3: 1, 4: 5, 5: 50, 6: 1000 },
                    7: { 3: 1, 4: 3, 5: 10, 6: 100, 7: 2500 },
                    8: { 4: 2, 5: 5, 6: 25, 7: 250, 8: 5000 },
                    9: { 4: 1, 5: 3, 6: 10, 7: 100, 8: 1000, 9: 10000 },
                    10: { 5: 2, 6: 5, 7: 20, 8: 200, 9: 2000, 10: 25000 },
                };

                const updateKenoPayoutPreview = () => {
                    const numSelected = kenoSelected.length;
                    if (numSelected >= 2 && kenoPayouts[numSelected]) {
                        const payouts = kenoPayouts[numSelected];
                        let html = `<p class="font-semibold">Jika memilih ${numSelected} angka:</p><ul class="list-disc list-inside">`;
                        for (const match in payouts) {
                            html += `<li>Cocok ${match} &rarr; <span class="font-bold text-amber-300">${payouts[match]}x</span> taruhan</li>`;
                        }
                        html += '</ul>';
                        kenoPayoutPreviewEl.innerHTML = html;
                    } else {
                        kenoPayoutPreviewEl.innerHTML = 'Pilih 2 hingga 10 angka untuk melihat tabel payout.';
                    }
                };

                const setup_keno = () => {
                    kenoGrid.innerHTML = '';
                    kenoSelected = [];
                    kenoResultEl.textContent = '';
                    kenoDrawBtn.disabled = true;
                    kenoResetBtn.disabled = false;
                    kenoBetInput.disabled = false;
                    kenoGrid.style.pointerEvents = 'auto';

                    for (let i = 1; i <= 80; i++) {
                        const ball = document.createElement('div');
                        ball.className = 'keno-ball border-2 border-slate-600 rounded-full flex items-center justify-center aspect-square cursor-pointer text-xs';
                        ball.textContent = i;
                        ball.dataset.number = i;
                        ball.addEventListener('click', () => {
                            const num = parseInt(ball.dataset.number);
                            if (kenoSelected.includes(num)) {
                                kenoSelected = kenoSelected.filter(n => n !== num);
                                ball.classList.remove('selected');
                            } else if (kenoSelected.length < 10) {
                                kenoSelected.push(num);
                                ball.classList.add('selected');
                            }
                            kenoDrawBtn.disabled = kenoSelected.length < 2;
                            updateKenoPayoutPreview();
                        });
                        kenoGrid.appendChild(ball);
                    }
                    updateKenoPayoutPreview();
                };
                window.setup_keno = setup_keno;
                
                kenoResetBtn.addEventListener('click', setup_keno);

                kenoDrawBtn.addEventListener('click', () => {
                    const bet = getValidBet('#modal-keno');
                    if (bet === null) return;
                    
                    currentUser.balance -= bet;
                    saveUserData();

                    kenoDrawBtn.disabled = true;
                    kenoResetBtn.disabled = true;
                    kenoBetInput.disabled = true;
                    kenoGrid.style.pointerEvents = 'none';
                    kenoResultEl.textContent = "Mengundi angka...";
                    
                    let drawnNumbers = new Set();
                    while(drawnNumbers.size < 20) {
                        drawnNumbers.add(Math.floor(Math.random() * 80) + 1);
                    }
                    
                    const drawnArray = Array.from(drawnNumbers);
                    let matches = 0;

                    drawnArray.forEach((num, i) => {
                        setTimeout(() => {
                           const ball = kenoGrid.querySelector(`[data-number="${num}"]`);
                           if (ball) ball.classList.add('drawn');
                           if(kenoSelected.includes(num)) {
                               if (ball) ball.classList.add('match');
                               matches++;
                           }
                           
                           if (i === drawnArray.length - 1) { 
                                const selectedCount = kenoSelected.length;
                                const winMulti = (kenoPayouts[selectedCount] && kenoPayouts[selectedCount][matches]) || 0;
                                const winnings = bet * winMulti;

                                if(winnings > 0) {
                                    currentUser.balance += winnings;
                                    kenoResultEl.textContent = `Cocok ${matches} dari ${selectedCount}! Anda menang ${winnings.toLocaleString('id-ID')}!`;
                                } else {
                                    kenoResultEl.textContent = `Cocok ${matches} dari ${selectedCount}. Coba lagi.`;
                                }
                                saveUserData();
                                kenoResetBtn.disabled = false;
                           }
                        }, i * 100);
                    });
                });
                
                // --- CRASH LOGIC (REWORKED) ---
                const crashCanvas = document.getElementById('crash-canvas');
                const crashCtx = crashCanvas.getContext('2d');
                const multiplierEl = document.getElementById('crash-multiplier-display');
                const crashBtn = document.getElementById('crash-btn');
                const crashResultEl = document.getElementById('crash-result');
                window.draw_crashcanvas = () => {
                    if (!crashCanvas.getContext) return;
                    crashCtx.clearRect(0, 0, crashCanvas.width, crashCanvas.height);
                    crashCtx.beginPath();
                    crashCtx.moveTo(0, crashCanvas.height);
                    const plotX = (multiplier - 1) * (crashCanvas.width / 5);
                    const plotY = crashCanvas.height - Math.log(multiplier) * (crashCanvas.height / 2);
                    crashCtx.lineTo(plotX, plotY);
                    crashCtx.strokeStyle = '#F59E0B';
                    crashCtx.lineWidth = 4;
                    crashCtx.stroke();
                };
                let multiplier, crashPoint, gameState; // ready, playing, crashed

                const crashGameLoop = () => {
                    // Dynamic multiplier increase
                    if (multiplier < 10) {
                        multiplier += 0.005;
                    } else if (multiplier < 50) {
                        multiplier += 0.02;
                    } else {
                        multiplier += 0.1;
                    }
                    
                    multiplierEl.textContent = `${multiplier.toFixed(2)}x`;
                    draw_crashcanvas();

                    if (multiplier >= crashPoint) {
                        gameState = 'crashed';
                        cancelAnimationFrame(crashGameLoopId);
                        crashGameLoopId = null;
                        multiplierEl.style.color = '#EF4444'; // red-500
                        crashResultEl.textContent = `CRASH di ${crashPoint.toFixed(2)}x!`;
                        crashBtn.textContent = 'Mulai Lagi';
                        crashBtn.className = "w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300";
                        saveUserData(); // Save balance on crash
                    } else {
                        crashGameLoopId = requestAnimationFrame(crashGameLoop);
                    }
                };

                window.setup_crash = () => {
                    gameState = 'ready';
                    multiplier = 1.00;
                    handleCanvasResize();
                    crashResultEl.textContent = '';
                    multiplierEl.textContent = '1.00x';
                    multiplierEl.style.color = 'white';
                    crashBtn.textContent = 'Mulai';
                    crashBtn.className = "w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300";
                };

                crashBtn.addEventListener('click', () => {
                    if (gameState === 'ready' || gameState === 'crashed') {
                        const bet = getValidBet('#modal-crash');
                        if (bet === null) return;
                        
                        currentUser.balance -= bet;
                        saveUserData();
                        
                        gameState = 'playing';
                        multiplier = 1.00;
                        crashPoint = 1 + Math.pow(Math.random(), 3) * 20;
                        crashResultEl.textContent = '';
                        multiplierEl.style.color = 'white';
                        crashBtn.textContent = 'Cash Out';
                        crashBtn.className = "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300";
                        crashGameLoop();
                    } else if (gameState === 'playing') {
                        const bet = parseInt(document.querySelector('#modal-crash .bet-input').value); // Re-read bet value for safety
                        gameState = 'crashed';
                        cancelAnimationFrame(crashGameLoopId);
                        crashGameLoopId = null;
                        const winnings = bet * multiplier;
                        currentUser.balance += winnings;
                        saveUserData();
                        crashResultEl.textContent = `Anda Cash Out di ${multiplier.toFixed(2)}x! Menang ${winnings.toLocaleString('id-ID')}!`;
                        multiplierEl.style.color = '#22C55E'; // green-500
                        crashBtn.textContent = 'Mulai Lagi';
                        crashBtn.className = "w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300";
                    }
                });
                
                // --- COIN FLIP LOGIC ---
                window.setup_coinflip = () => {
                    document.getElementById('coinflip-result').textContent = '';
                };
                const handleCoinFlip = (choice) => {
                    const bet = getValidBet('#modal-coinflip');
                    if (bet === null) return;
                    
                     currentUser.balance -= bet;
                     const resultEl = document.getElementById('coinflip-result');
                     const coinEl = document.getElementById('coinflip-coin');
                     const result = Math.random() < 0.5 ? 'heads' : 'tails';
                     
                     coinEl.textContent = result === 'heads' ? '👑' : '🪙';
                     
                     if (choice === result) {
                         const winnings = bet * 2;
                         currentUser.balance += winnings;
                         resultEl.textContent = `Anda menang ${winnings.toLocaleString('id-ID')}!`;
                     } else {
                         resultEl.textContent = 'Anda kalah.';
                     }
                     saveUserData();
                };
                document.getElementById('coinflip-heads').addEventListener('click', () => handleCoinFlip('heads'));
                document.getElementById('coinflip-tails').addEventListener('click', () => handleCoinFlip('tails'));
                
                // --- ROULETTE LOGIC ---
                const redNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
                window.setup_roulette = () => {
                    document.getElementById('roulette-result-text').textContent = '';
                };
                document.querySelectorAll('.roulette-bet-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const bet = getValidBet('#modal-roulette');
                        if (bet === null) return;

                        currentUser.balance -= bet;
                        const resultTextEl = document.getElementById('roulette-result-text');
                        
                        const winningNumber = Math.floor(Math.random() * 37); // 0-36
                        document.getElementById('roulette-result-number').textContent = winningNumber;

                        const betType = e.target.dataset.bet;
                        let isWin = false;
                        if(betType === 'red' && redNumbers.includes(winningNumber)) isWin = true;
                        if(betType === 'black' && !redNumbers.includes(winningNumber) && winningNumber !== 0) isWin = true;
                        if(betType === 'even' && winningNumber % 2 === 0 && winningNumber !== 0) isWin = true;
                        if(betType === 'odd' && winningNumber % 2 !== 0 && winningNumber !== 0) isWin = true;

                        if(isWin) {
                            const winnings = bet * 2;
                            currentUser.balance += winnings;
                            resultTextEl.textContent = `Menang ${winnings.toLocaleString('id-ID')}!`;
                        } else {
                             resultTextEl.textContent = 'Kalah. Coba lagi.';
                        }
                        saveUserData();
                    });
                });
                
                // --- BACCARAT LOGIC ---
                const getBaccaratCardValue = (card) => {
                    if (['10', 'J', 'Q', 'K'].includes(card.value)) return 0;
                    if (card.value === 'A') return 1;
                    return parseInt(card.value);
                };
                window.setup_baccarat = () => {
                    document.getElementById('baccarat-result').textContent = '';
                    document.getElementById('baccarat-player-cards').innerHTML = '';
                    document.getElementById('baccarat-banker-cards').innerHTML = '';
                    document.getElementById('baccarat-player-score').textContent = '0';
                    document.getElementById('baccarat-banker-score').textContent = '0';
                };
                document.querySelectorAll('.baccarat-bet-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const bet = getValidBet('#modal-baccarat');
                        if (bet === null) return;
                        
                        currentUser.balance -= bet;
                        const resultEl = document.getElementById('baccarat-result');
                        
                        let deck = shuffleDeck(createDeck());
                        let playerCards = [deck.pop(), deck.pop()];
                        let bankerCards = [deck.pop(), deck.pop()];
                        
                        const calculateScore = (hand) => (hand.reduce((acc, card) => acc + getBaccaratCardValue(card), 0)) % 10;
                        let playerScore = calculateScore(playerCards);
                        let bankerScore = calculateScore(bankerCards);

                        if (playerScore <= 5) playerCards.push(deck.pop());
                        playerScore = calculateScore(playerCards);
                        if (bankerScore <= 5) bankerCards.push(deck.pop());
                        bankerScore = calculateScore(bankerCards);
                        
                        document.getElementById('baccarat-player-cards').innerHTML = '';
                        playerCards.forEach(c => document.getElementById('baccarat-player-cards').appendChild(createCardElement(c)));
                        document.getElementById('baccarat-banker-cards').innerHTML = '';
                        bankerCards.forEach(c => document.getElementById('baccarat-banker-cards').appendChild(createCardElement(c)));

                        document.getElementById('baccarat-player-score').textContent = playerScore;
                        document.getElementById('baccarat-banker-score').textContent = bankerScore;
                        
                        const betOn = e.target.dataset.bet;
                        let winner = '';
                        if(playerScore > bankerScore) winner = 'player';
                        else if (bankerScore > playerScore) winner = 'banker';
                        else winner = 'tie';

                        if(betOn === winner) {
                            const multiplier = betOn === 'tie' ? 9 : 2;
                            const winnings = bet * multiplier;
                            currentUser.balance += winnings;
                            resultEl.textContent = `${winner.toUpperCase()} menang! Anda dapat ${winnings.toLocaleString('id-ID')}.`;
                        } else {
                            resultEl.textContent = `${winner.toUpperCase()} menang. Anda kalah.`;
                        }
                        saveUserData();
                    });
                });
                
                // --- VIDEO POKER LOGIC (REWORKED & FIXED) ---
                let pokerHand, pokerDeck, pokerStage;
                const pokerResultEl = document.getElementById('poker-result');
                const pokerHandEl = document.getElementById('poker-hand');
                
                const evaluatePokerHand = (hand) => {
                    const rankOrder = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
                    const ranks = hand.map(card => rankOrder.indexOf(card.value)).sort((a, b) => a - b);
                    const suits = hand.map(card => card.suit);
                    
                    const isFlush = suits.every(s => s === suits[0]);
                    const rankSet = new Set(ranks);
                    // Check for normal straight or A-2-3-4-5 straight
                    const isStraight = (rankSet.size === 5 && (ranks[4] - ranks[0] === 4)) || 
                                     (ranks.toString() === '0,1,2,3,12'); // A,2,3,4,5

                    if (isStraight && isFlush) {
                        if (ranks[4] === 12 && ranks[3] === 11) return { hand: "Royal Flush", mult: 250 };
                        return { hand: "Straight Flush", mult: 50 };
                    }

                    const rankCount = {};
                    hand.forEach(card => {
                        rankCount[card.value] = (rankCount[card.value] || 0) + 1;
                    });
                    const counts = Object.values(rankCount);
                    const hasQuads = counts.includes(4);
                    const hasTrips = counts.includes(3);
                    const pairs = counts.filter(c => c === 2).length;

                    if (hasQuads) return { hand: "Four of a Kind", mult: 25 };
                    if (hasTrips && pairs === 1) return { hand: "Full House", mult: 9 };
                    if (isFlush) return { hand: "Flush", mult: 6 };
                    if (isStraight) return { hand: "Straight", mult: 5 };
                    if (hasTrips) return { hand: "Three of a Kind", mult: 4 };
                    if (pairs === 2) return { hand: "Two Pair", mult: 3 };
                    if (pairs === 1) {
                        const pairRank = Object.keys(rankCount).find(rank => rankCount[rank] === 2);
                        if (rankOrder.indexOf(pairRank) >= 9) { // Jacks or better
                            return { hand: "Jacks or Better", mult: 2 };
                        }
                    }
                    
                    return { hand: "High Card", mult: 0 };
                };
                
                const startPoker = () => {
                     const bet = getValidBet('#modal-poker');
                     if (bet === null) return;

                     currentUser.balance -= bet;
                     saveUserData();

                     pokerDeck = shuffleDeck(createDeck());
                     pokerHand = [];
                     for(let i=0; i<5; i++) pokerHand.push(pokerDeck.pop());
                     pokerStage = 'deal';
                     renderPokerHand();
                     document.getElementById('poker-deal-btn').classList.add('hidden');
                     document.getElementById('poker-draw-btn').classList.remove('hidden');
                     pokerResultEl.textContent = '';
                };

                const renderPokerHand = () => {
                    pokerHandEl.innerHTML = '';
                    pokerHand.forEach((card, index) => {
                        const cardEl = createCardElement(card);
                        cardEl.dataset.index = index;
                        if(card.held) cardEl.style.border = '2px solid #F59E0B';
                        cardEl.addEventListener('click', () => {
                            if(pokerStage !== 'deal') return;
                            card.held = !card.held;
                            renderPokerHand();
                        });
                        pokerHandEl.appendChild(cardEl);
                    });
                };
                
                window.setup_poker = () => {
                    pokerStage = 'end';
                    document.getElementById('poker-deal-btn').classList.remove('hidden');
                    document.getElementById('poker-draw-btn').classList.add('hidden');
                    pokerHandEl.innerHTML = '';
                    pokerResultEl.textContent = '';
                };
                document.getElementById('poker-deal-btn').addEventListener('click', startPoker);
                document.getElementById('poker-draw-btn').addEventListener('click', () => {
                    const bet = parseInt(document.querySelector('#modal-poker .bet-input').value);
                    pokerHand.forEach((card, i) => {
                        if (!card.held) {
                            pokerHand[i] = pokerDeck.pop();
                        }
                    });
                    pokerStage = 'end';
                    renderPokerHand();
                    
                    const result = evaluatePokerHand(pokerHand);
                    const winnings = bet * result.mult;
                    if(winnings > 0) {
                        currentUser.balance += winnings;
                        pokerResultEl.textContent = `${result.hand}! Anda menang ${winnings.toLocaleString('id-ID')}!`;
                    } else {
                        pokerResultEl.textContent = `Tidak ada kombinasi. Coba lagi.`;
                    }
                    saveUserData();

                    document.getElementById('poker-deal-btn').classList.remove('hidden');
                    document.getElementById('poker-draw-btn').classList.add('hidden');
                });
                
                // --- HI-LO LOGIC (FIXED) ---
                let hiloCurrentCard, hiloDeck;
                const rankOrder = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

                window.setup_hilo = () => {
                    hiloDeck = shuffleDeck(createDeck());
                    hiloCurrentCard = hiloDeck.pop();
                    
                    const newCurrentCard = createCardElement(hiloCurrentCard);
                    newCurrentCard.id = 'hilo-current-card';
                    document.getElementById('hilo-current-card').replaceWith(newCurrentCard);
                    
                    const nextCardEl = document.getElementById('hilo-next-card');
                    nextCardEl.className = 'card hidden-card';
                    nextCardEl.innerHTML = '?';

                    document.getElementById('hilo-result').textContent = '';
                    document.getElementById('hilo-high-btn').disabled = false;
                    document.getElementById('hilo-low-btn').disabled = false;
                };
                
                const handleHilo = (choice) => {
                    const bet = getValidBet('#modal-hilo');
                    if(bet === null) return;

                    currentUser.balance -= bet;
                    const resultEl = document.getElementById('hilo-result');
                    
                    const nextCard = hiloDeck.pop();
                    const newNextCard = createCardElement(nextCard);
                    newNextCard.id = 'hilo-next-card';
                    document.getElementById('hilo-next-card').replaceWith(newNextCard);
                    
                    const currentRank = rankOrder.indexOf(hiloCurrentCard.value);
                    const nextRank = rankOrder.indexOf(nextCard.value);

                    let result = '';
                    if (nextRank > currentRank) result = 'high';
                    else if (nextRank < currentRank) result = 'low';
                    else result = choice; // win on same rank

                    if (choice === result) {
                        const winnings = bet * 2;
                        currentUser.balance += winnings;
                        resultEl.textContent = `Benar! Anda menang ${winnings.toLocaleString('id-ID')}!`;
                    } else {
                        resultEl.textContent = 'Salah. Coba lagi.';
                    }
                    saveUserData();
                    hiloCurrentCard = nextCard;
                    document.getElementById('hilo-high-btn').disabled = true;
                    document.getElementById('hilo-low-btn').disabled = true;
                    setTimeout(window.setup_hilo, 2000);
                };
                document.getElementById('hilo-high-btn').addEventListener('click', () => handleHilo('high'));
                document.getElementById('hilo-low-btn').addEventListener('click', () => handleHilo('low'));

                // --- SCRATCH CARD LOGIC (REWORKED) ---
                const setup_scratch = () => {
                    const bet = getValidBet('#modal-scratch');
                    if(bet === null) return;

                    currentUser.balance -= bet;
                    saveUserData();

                    const resultEl = document.getElementById('scratch-result');
                    const newCardBtn = document.getElementById('scratch-new-btn');
                    const grid = document.getElementById('scratch-grid');
                    
                    newCardBtn.disabled = true;
                    resultEl.textContent = 'Pilih 3 kotak untuk dibuka.';
                    grid.innerHTML = '';

                    let clickCount = 0;
                    let revealedSymbols = [];
                    const allCovers = [];

                    const symbols = ['🍒', '🍋', '🔔', '💰', '⭐', '💎'];
                    let cardSymbols = [];
                    for (let i = 0; i < 9; i++) {
                        cardSymbols.push(symbols[Math.floor(Math.random() * symbols.length)]);
                    }
                    shuffleDeck(cardSymbols);

                    cardSymbols.forEach(symbol => {
                        const cell = document.createElement('div');
                        cell.className = 'relative w-full h-full';
                        const cover = document.createElement('div');
                        cover.className = 'scratch-card-cover absolute inset-0 bg-slate-500 cursor-pointer';
                        
                        cell.innerHTML = `<div class="absolute inset-0 flex items-center justify-center text-4xl">${symbol}</div>`;
                        cell.appendChild(cover);
                        allCovers.push(cover);

                        const handleClick = (e) => {
                            e.target.style.opacity = '0';
                            e.target.style.cursor = 'default';
                            clickCount++;
                            revealedSymbols.push(symbol);

                            if (clickCount === 3) {
                                allCovers.forEach(c => c.style.pointerEvents = 'none');

                                const isWin = revealedSymbols[0] === revealedSymbols[1] && revealedSymbols[1] === revealedSymbols[2];
                                
                                if (isWin) {
                                    const winnings = bet * 5;
                                    currentUser.balance += winnings;
                                    resultEl.textContent = `Selamat! Anda menang ${winnings.toLocaleString('id-ID')}!`;
                                } else {
                                    resultEl.textContent = 'Anda kalah. Coba lagi.';
                                    // Reveal remaining cards on loss
                                    setTimeout(() => {
                                        allCovers.forEach(c => {
                                            if (window.getComputedStyle(c).opacity !== '0') {
                                                c.style.transition = 'opacity 0.5s';
                                                c.style.opacity = '0';
                                            }
                                        });
                                    }, 500);
                                }
                                saveUserData();
                                newCardBtn.disabled = false;
                            }
                        };
                        
                        cover.addEventListener('click', handleClick, { once: true });
                        grid.appendChild(cell);
                    });
                };
                window.setup_scratch = setup_scratch;
                document.getElementById('scratch-new-btn').addEventListener('click', setup_scratch);

                // --- WHEEL OF FORTUNE LOGIC ---
                const wheelCanvas = document.getElementById('wheelCanvas');
                const wheelCtx = wheelCanvas.getContext('2d');
                const segments = [
                    { color: '#10B981', label: '1x' },  // Green
                    { color: '#3B82F6', label: '3x' },  // Blue
                    { color: '#F59E0B', label: '2x' },  // Amber
                    { color: '#6366F1', label: '5x' },  // Indigo
                    { color: '#DC2626', label: '-5x'}, // Red (loss)
                    { color: '#EC4899', label: '10x'}, // Pink (big win)
                    { color: '#9333EA', label: '-3x' }, // Purple (loss)
                    { color: '#EF4444', label: '-2x' }  // Lighter Red (loss)
                ];
                const segmentAngle = (2 * Math.PI) / segments.length;
                
                window.draw_wheelCanvas = () => {
                    if (!wheelCanvas.getContext) return;
                    const size = wheelCanvas.width;
                    const radius = size / 2;
                    wheelCtx.clearRect(0, 0, size, size);
                    segments.forEach((segment, i) => {
                        wheelCtx.beginPath();
                        wheelCtx.moveTo(radius, radius);
                        wheelCtx.arc(radius, radius, radius, i * segmentAngle, (i + 1) * segmentAngle);
                        wheelCtx.fillStyle = segment.color;
                        wheelCtx.fill();
                        wheelCtx.save();
                        wheelCtx.fillStyle = 'white';
                        const fontSize = Math.max(12, size / 15);
                        wheelCtx.font = `bold ${fontSize}px Inter`;
                        wheelCtx.translate(radius + (radius * 0.65) * Math.cos(i * segmentAngle + segmentAngle / 2), radius + (radius * 0.65) * Math.sin(i * segmentAngle + segmentAngle / 2));
                        wheelCtx.rotate(i * segmentAngle + segmentAngle / 2 + Math.PI / 2);
                        wheelCtx.fillText(segment.label, -wheelCtx.measureText(segment.label).width / 2, 0);
                        wheelCtx.restore();
                    });
                };

                window.setup_wheel = () => {
                    document.getElementById('wheel-result').textContent = '';
                    handleCanvasResize();
                };

                document.getElementById('wheel-spin-btn').addEventListener('click', () => {
                    const bet = getValidBet('#modal-wheel');
                    if (bet === null) return;

                    const resultEl = document.getElementById('wheel-result');
                    const spinBtn = document.getElementById('wheel-spin-btn');
                     
                     const initialBalance = currentUser.balance;
                     currentUser.balance -= bet;
                     
                     saveUserData();
                     spinBtn.disabled = true;
                     resultEl.textContent = '';
                     resultEl.style.color = '';

                     const randomSpin = Math.random() * 360 + 360 * 5; 
                     wheelCanvas.style.transform = `rotate(${randomSpin}deg)`;
                     
                     setTimeout(() => {
                        const degreesPerSegment = 360 / segments.length;
                        const finalAngle = randomSpin % 360;
                        const normalizedAngle = (270 - finalAngle + 360) % 360;
                        const winningIndex = Math.floor(normalizedAngle / degreesPerSegment);

                        const winningSegment = segments[winningIndex];
                        const multiplier = parseFloat(winningSegment.label.replace('x', ''));
                        
                        const changeAmount = bet * (multiplier - 1); // Net change
                        currentUser.balance = initialBalance + changeAmount;
                        
                        if (currentUser.balance < 0) {
                            currentUser.balance = 0;
                        }

                        const netResult = currentUser.balance - initialBalance;
                        
                        if (netResult >= 0) {
                            resultEl.textContent = `Anda dapat ${winningSegment.label}! Menang ${netResult.toLocaleString('id-ID')}!`;
                            resultEl.style.color = '#22C55E';
                        } else {
                             resultEl.textContent = `Anda dapat ${winningSegment.label}! Kalah ${Math.abs(netResult).toLocaleString('id-ID')}!`;
                             resultEl.style.color = '#EF4444';
                        }
                         
                         saveUserData();
                         spinBtn.disabled = false;
                     }, 4100);
                });

                // --- GUESS THE NUMBER LOGIC ---
                let guessNumberSecret, guessNumberAttempts, guessNumberBet;
                
                const endGuessNumberGame = () => {
                    document.getElementById('guessnumber-game-screen').classList.add('hidden');
                    document.getElementById('guessnumber-start-screen').classList.remove('hidden');
                    document.querySelector('#modal-guessnumber .bet-input').disabled = false;
                };

                window.setup_guessnumber = () => {
                    document.getElementById('guessnumber-start-screen').classList.remove('hidden');
                    document.getElementById('guessnumber-game-screen').classList.add('hidden');
                    document.getElementById('guessnumber-result').textContent = '';
                    document.querySelector('#modal-guessnumber .bet-input').disabled = false;
                };

                document.getElementById('guessnumber-start-btn').addEventListener('click', () => {
                    guessNumberBet = getValidBet('#modal-guessnumber');
                    if (guessNumberBet === null) return;

                    currentUser.balance -= guessNumberBet;
                    saveUserData();

                    guessNumberSecret = Math.floor(Math.random() * 100) + 1;
                    guessNumberAttempts = 3;
                    
                    document.getElementById('guessnumber-attempts').textContent = guessNumberAttempts;
                    document.getElementById('guessnumber-input').value = '';
                    document.getElementById('guessnumber-result').textContent = 'Angka rahasia telah ditentukan. Silakan tebak!';
                    
                    document.getElementById('guessnumber-start-screen').classList.add('hidden');
                    document.getElementById('guessnumber-game-screen').classList.remove('hidden');
                    document.querySelector('#modal-guessnumber .bet-input').disabled = true;
                });

                document.getElementById('guessnumber-guess-btn').addEventListener('click', () => {
                    const guessInput = document.getElementById('guessnumber-input');
                    const resultEl = document.getElementById('guessnumber-result');
                    const guess = parseInt(guessInput.value);

                    if (isNaN(guess) || guess < 1 || guess > 100) {
                        resultEl.textContent = 'Masukkan angka valid antara 1 dan 100.';
                        return;
                    }

                    guessNumberAttempts--;
                    document.getElementById('guessnumber-attempts').textContent = guessNumberAttempts;

                    if (guess === guessNumberSecret) {
                        let multiplier = 0;
                        if (guessNumberAttempts === 2) multiplier = 5;      // 1st try
                        else if (guessNumberAttempts === 1) multiplier = 3; // 2nd try
                        else if (guessNumberAttempts === 0) multiplier = 2; // 3rd try

                        const winnings = guessNumberBet * multiplier;
                        currentUser.balance += winnings;
                        saveUserData();
                        
                        resultEl.innerHTML = `BENAR! Angkanya adalah ${guessNumberSecret}.<br>Anda menang ${winnings.toLocaleString('id-ID')}!`;
                        endGuessNumberGame();

                    } else {
                        if (guessNumberAttempts > 0) {
                            const diff = Math.abs(guess - guessNumberSecret);
                            let hint = '';
                            if (guess < guessNumberSecret) {
                                hint = 'Terlalu KECIL. ';
                                if (diff < 5) hint += 'Tambah dikit lagi!';
                            } else {
                                hint = 'Terlalu BESAR. ';
                                if (diff < 5) hint += 'Kurangi dikit lagi!';
                            }
                            resultEl.textContent = hint;
                        } else {
                            resultEl.innerHTML = `Kesempatan habis! Angka rahasianya adalah ${guessNumberSecret}.<br>Anda kalah.`;
                            endGuessNumberGame();
                        }
                    }
                    guessInput.value = '';
                    guessInput.focus();
                });
                
                // --- TRADING LOGIC ---
                let tradingState = {};
                let tradingCountdownInterval, tradingAnimationInterval;

                window.draw_tradingcanvas = () => {
                    const canvas = document.getElementById('trading-canvas');
                    if (!canvas || !canvas.getContext) return;
                    const ctx = canvas.getContext('2d');
                    const { width, height } = canvas;
                    const data = tradingState.chartData || [];
                    if (data.length === 0) return;

                    ctx.clearRect(0, 0, width, height);

                    const maxPrice = Math.max(...data, tradingState.startPrice);
                    const minPrice = Math.min(...data, tradingState.startPrice);
                    const priceRange = maxPrice - minPrice || 1;
                    
                    const toY = (price) => height - ((price - minPrice) / priceRange) * (height - 20) - 10;
                    const toX = (index) => (index / (data.length -1)) * width;

                    // Draw start price line
                    const startY = toY(tradingState.startPrice);
                    ctx.strokeStyle = '#64748B'; // slate-500
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(0, startY);
                    ctx.lineTo(width, startY);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // Draw price line
                    const lastPrice = data[data.length - 1];
                    ctx.strokeStyle = lastPrice >= tradingState.startPrice ? '#22C55E' : '#EF4444'; // green/red
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(0, toY(data[0]));
                    data.forEach((price, index) => {
                        ctx.lineTo(toX(index), toY(price));
                    });
                    ctx.stroke();
                };

                const endTradingGame = () => {
                    document.getElementById('trading-start-screen').classList.remove('hidden');
                    document.getElementById('trading-game-screen').classList.add('hidden');
                    document.querySelector('#modal-trading .bet-input').disabled = false;
                };

                const evaluateTradingResult = () => {
                    const finalPrice = tradingState.chartData[tradingState.chartData.length - 1];
                    const outcome = finalPrice > tradingState.startPrice ? 'up' : 'down';
                    const resultEl = document.getElementById('trading-result');
                    
                    if (tradingState.prediction === outcome) {
                        const priceDiff = Math.abs(finalPrice - tradingState.startPrice);
                        let multiplier = 2; // Default close win
                        if (priceDiff > tradingState.startPrice * 0.1) multiplier = 5; // Far win
                        else if (priceDiff > tradingState.startPrice * 0.05) multiplier = 3; // Medium win
                        
                        const winnings = tradingState.bet * multiplier;
                        currentUser.balance += winnings;
                        resultEl.textContent = `Prediksi BENAR! Anda menang ${winnings.toLocaleString('id-ID')}!`;
                    } else {
                        resultEl.textContent = `Prediksi SALAH! Anda kalah.`;
                    }
                    saveUserData();
                    endTradingGame();
                };

                const runTradingAnimation = () => {
                    let steps = 0;
                    tradingAnimationInterval = setInterval(() => {
                        const lastPrice = tradingState.chartData[tradingState.chartData.length - 1];
                        const volatility = lastPrice * 0.02;
                        const newPrice = Math.max(0, lastPrice + (Math.random() - 0.48) * volatility);
                        tradingState.chartData.push(newPrice);
                        document.getElementById('trading-price').textContent = newPrice.toFixed(2);
                        draw_tradingcanvas();
                        
                        steps++;
                        if (steps >= 50) { // Animate for 5 seconds
                            clearInterval(tradingAnimationInterval);
                            evaluateTradingResult();
                        }
                    }, 100);
                };

                const handleTradingPrediction = (prediction) => {
                    tradingState.prediction = prediction;
                    document.getElementById('trading-up-btn').disabled = true;
                    document.getElementById('trading-down-btn').disabled = true;
                    document.getElementById('trading-result').textContent = 'Prediksi dikunci! Menunggu hasil...';

                    if (tradingState.countdown <= 0) { // If timer already finished
                        runTradingAnimation();
                    }
                };

                window.setup_trading = () => {
                    if (tradingCountdownInterval) clearInterval(tradingCountdownInterval);
                    if (tradingAnimationInterval) clearInterval(tradingAnimationInterval);
                    document.getElementById('trading-start-screen').classList.remove('hidden');
                    document.getElementById('trading-game-screen').classList.add('hidden');
                    document.getElementById('trading-result').textContent = '';
                    document.querySelector('#modal-trading .bet-input').disabled = false;
                };

                document.getElementById('trading-start-btn').addEventListener('click', () => {
                    const bet = getValidBet('#modal-trading');
                    if (bet === null) return;

                    currentUser.balance -= bet;
                    saveUserData();

                    tradingState = {
                        bet: bet,
                        prediction: null,
                        countdown: 20,
                        startPrice: 100 + (Math.random() - 0.5) * 20,
                        chartData: [100 + (Math.random() - 0.5) * 10]
                    };
                    for(let i=0; i<10; i++) {
                        const last = tradingState.chartData[i];
                        tradingState.chartData.push(last + (Math.random() - 0.5) * 5);
                    }
                    tradingState.chartData.push(tradingState.startPrice);

                    document.getElementById('trading-price').textContent = tradingState.startPrice.toFixed(2);
                    document.getElementById('trading-timer').textContent = tradingState.countdown;
                    document.getElementById('trading-result').textContent = '';
                    
                    const upBtn = document.getElementById('trading-up-btn');
                    const downBtn = document.getElementById('trading-down-btn');
                    upBtn.disabled = false;
                    downBtn.disabled = false;

                    document.getElementById('trading-start-screen').classList.add('hidden');
                    document.getElementById('trading-game-screen').classList.remove('hidden');
                    document.querySelector('#modal-trading .bet-input').disabled = true;

                    handleCanvasResize();
                    
                    tradingCountdownInterval = setInterval(() => {
                        tradingState.countdown--;
                        document.getElementById('trading-timer').textContent = tradingState.countdown;
                        if (tradingState.countdown <= 0) {
                            clearInterval(tradingCountdownInterval);
                            upBtn.disabled = true;
                            downBtn.disabled = true;
                            if (tradingState.prediction) {
                                runTradingAnimation();
                            } else {
                                document.getElementById('trading-result').textContent = 'Waktu habis! Menjalankan chart...';
                                setTimeout(runTradingAnimation, 1000);
                            }
                        }
                    }, 1000);
                });
                document.getElementById('trading-up-btn').addEventListener('click', () => handleTradingPrediction('up'));
                document.getElementById('trading-down-btn').addEventListener('click', () => handleTradingPrediction('down'));

            }
            // --- START THE APP ---
            initializeApp();
        });
    </script>
</body>
</html>

