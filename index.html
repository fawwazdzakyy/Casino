<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Casino - Situs Game Demo Terlengkap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Slate 900 */
            scroll-behavior: smooth;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1E293B; }
        ::-webkit-scrollbar-thumb { background: #F59E0B; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #D97706; }
        
        .hero-bg {
            background-image: linear-gradient(to top, #0F172A, rgba(15, 23, 42, 0.7)), url('https://placehold.co/1920x1080/0a0a0a/eab308?text=Galaxy+Casino');
            background-size: cover;
            background-position: center;
        }

        .modal-content, .auth-form {
            animation: slide-up 0.3s ease-out;
        }
        @keyframes slide-up {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .auth-input {
            background-color: #1E293B; border: 1px solid #334155; border-radius: 0.5rem;
            padding: 0.75rem 1rem; color: #F1F5F9; width: 100%; transition: all 0.2s;
        }
        .auth-input:focus {
            outline: none; border-color: #F59E0B;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.5);
        }
        
        .scratch-card-cover {
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        #wheelCanvas {
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        .keno-ball { transition: all 0.3s ease; }
        .keno-ball.selected { background-color: #F59E0B; border-color: #FBBF24; color: #1E293B; transform: scale(1.1); }
        .keno-ball.drawn { background-color: #10B981; border-color: #34D399; }
        .keno-ball.match { background-color: #3B82F6; border-color: #60A5FA; animation: pulse 1s infinite; }

        @keyframes pulse { 0%, 100% { transform: scale(1.1); } 50% { transform: scale(1.2); } }
        
        .card {
            width: 50px;
            height: 70px;
            border-radius: 5px;
            background-color: white;
            border: 1px solid #333;
            color: black;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        .card.red { color: #DC2626; }
        .card.hidden-card { background-color: #DC2626; }
    </style>
</head>
<body class="text-gray-200">

    <!-- Header / Navbar -->
    <header class="bg-slate-800/50 backdrop-blur-sm sticky top-0 z-50 border-b border-slate-700">
        <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="#" class="text-2xl font-bold text-amber-400">
                <i data-lucide="gem" class="inline-block mr-2"></i>GalaxyCasino
            </a>
            <div id="auth-buttons" class="flex items-center space-x-2">
                <button id="show-login-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 text-sm">Masuk</button>
                <button id="show-register-btn" class="bg-amber-500 hover:bg-amber-600 text-slate-900 font-semibold py-2 px-4 rounded-lg transition duration-300 text-sm">Daftar</button>
            </div>
            <div id="user-session" class="hidden items-center space-x-4">
                <div class="text-right">
                    <span id="username-display" class="font-semibold text-amber-400 block"></span>
                    <p class="mt-1 text-base font-bold bg-slate-700/50 text-amber-300 px-3 py-1 rounded-md shadow-inner">Saldo: <span id="balance-display"></span></p>
                </div>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-300 text-sm">Keluar</button>
            </div>
        </nav>
    </header>

    <!-- Auth Section -->
    <section id="auth-section" class="min-h-[80vh] flex items-center justify-center container mx-auto px-4">
        <!-- Login Form -->
        <div id="login-form" class="auth-form bg-slate-900 p-8 rounded-xl shadow-2xl w-full max-w-md hidden">
            <h2 class="text-3xl font-bold text-center text-amber-400 mb-6">Selamat Datang Kembali</h2>
            <form id="login-form-submit" class="space-y-4">
                <input type="text" id="login-username" placeholder="Username" class="auth-input" required>
                <input type="password" id="login-password" placeholder="Password" class="auth-input" required>
                <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg text-lg transition duration-300">Masuk</button>
            </form>
            <p id="login-error" class="text-red-500 text-center mt-4 h-5"></p>
            <p class="text-center mt-4 text-gray-400">Belum punya akun? <button id="switch-to-register" class="font-semibold text-amber-400 hover:underline">Daftar di sini</button></p>
        </div>
        <!-- Register Form -->
        <div id="register-form" class="auth-form bg-slate-900 p-8 rounded-xl shadow-2xl w-full max-w-md hidden">
            <h2 class="text-3xl font-bold text-center text-amber-400 mb-6">Buat Akun Baru</h2>
            <form id="register-form-submit" class="space-y-4">
                <input type="text" id="register-username" placeholder="Username (min. 5 karakter)" class="auth-input" required>
                <input type="tel" id="register-phone" placeholder="Nomor HP (Contoh: 08123456789)" class="auth-input" required>
                <input type="email" id="register-email" placeholder="Email (Contoh: user@email.com)" class="auth-input" required>
                <input type="password" id="register-password" placeholder="Password (min. 8 karakter)" class="auth-input" required>
                <p id="register-error" class="text-red-500 text-center h-5 text-sm"></p>
                <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg text-lg transition duration-300">Daftar</button>
            </form>
            <p class="text-center mt-4 text-gray-400">Sudah punya akun? <button id="switch-to-login" class="font-semibold text-amber-400 hover:underline">Masuk di sini</button></p>
        </div>
        <!-- Register Success -->
        <div id="register-success" class="auth-form text-center bg-slate-900 p-8 rounded-xl shadow-2xl w-full max-w-md hidden">
            <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
            <h2 class="text-2xl font-bold text-white">Pendaftaran Berhasil!</h2>
            <p class="text-gray-400 mt-2">Silakan masuk menggunakan akun baru Anda.</p>
            <button id="success-login-btn" class="mt-6 w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg text-lg transition duration-300">Lanjut Masuk</button>
        </div>
    </section>

    <!-- Main Content (Logged In) -->
    <div id="main-content" class="hidden">
        <main>
            <!-- Dashboard/Hero Section -->
            <section class="hero-bg min-h-[60vh] flex items-center justify-center text-center">
                <div class="bg-black/50 p-8 rounded-xl">
                    <h1 class="text-4xl md:text-6xl font-black text-white uppercase tracking-wider">
                        Kemenangan <span class="text-amber-400">Besar</span> Menanti
                    </h1>
                    <p class="mt-4 text-lg md:text-xl text-gray-300 max-w-2xl mx-auto">
                        Selamat datang, <span id="dashboard-username" class="font-bold text-white"></span>! Jelajahi berbagai permainan seru dan raih kesempatan emas Anda.
                    </p>
                    <a href="#mode-selection" class="mt-8 inline-block bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-full text-lg uppercase transition duration-300 transform hover:scale-105">
                        Mulai Bermain
                    </a>
                </div>
            </section>
            
            <!-- Mode Selection Section -->
            <section id="mode-selection" class="container mx-auto px-4 py-16 text-center">
                 <h2 class="text-3xl font-bold text-center mb-10">Pilih Mode Permainan</h2>
                <div class="mt-8 flex flex-col md:flex-row justify-center items-center gap-6">
                    <div id="play-demo-btn" class="w-full md:w-80 p-8 bg-slate-800 rounded-xl border border-amber-500 cursor-pointer transition-transform transform hover:scale-105">
                        <i data-lucide="play-circle" class="w-16 h-16 text-amber-400 mx-auto"></i>
                        <h2 class="text-2xl font-bold mt-4">Main Demo</h2>
                        <p class="text-gray-400 mt-1">Coba semua permainan dengan saldo virtual.</p>
                    </div>
                     <div class="w-full md:w-80 p-8 bg-slate-800 rounded-xl border border-slate-700 opacity-50 cursor-not-allowed">
                        <i data-lucide="credit-card" class="w-16 h-16 text-slate-500 mx-auto"></i>
                        <h2 class="text-2xl font-bold mt-4">Deposit</h2>
                        <p class="text-slate-500 mt-1">(Fitur ini sedang dalam pengembangan)</p>
                    </div>
                </div>
            </section>

            <!-- Game Selection Section (Hidden by default) -->
            <section id="games" class="container mx-auto px-4 py-16 hidden">
                <h2 class="text-3xl font-bold text-center mb-10">Pilih Permainan Favorit Anda</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 md:gap-6">
                    <!-- Game Cards will be inserted here by JS -->
                </div>
            </section>
        </main>
        <!-- Footer -->
        <footer class="bg-slate-900 border-t border-slate-700 mt-12">
            <div class="container mx-auto px-4 py-6 text-center text-gray-400">
                <p>&copy; 2025 Galaxy Casino. Semua game hanya untuk tujuan demonstrasi.</p>
            </div>
        </footer>
    </div>

    <!-- Game Modals Container -->
    <div id="modal-container" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] hidden p-4 overflow-y-auto">
        <!-- All 12 game modals will be injected here from JS Templates -->
    </div>

    <!-- SCRIPT UTAMA -->
    <script>
        // SCRIPT UTAMA DIMULAI DI SINI
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL VARIABLES & DATA ---
            let currentUser = null;
            const gamesData = [
                { id: 'slot', name: 'Slot Machine', icon: 'gem' },
                { id: 'dice', name: 'Dice / SicBo', icon: 'dice-5' },
                { id: 'blackjack', name: 'Blackjack', icon: 'spade' },
                { id: 'keno', name: 'Keno', icon: 'app-window' },
                { id: 'crash', name: 'Crash Game', icon: 'trending-up' },
                { id: 'roulette', name: 'Roulette', icon: 'circle-dashed' },
                { id: 'baccarat', name: 'Baccarat', icon: 'user-square-2' },
                { id: 'poker', name: 'Video Poker', icon: 'layers' },
                { id: 'hilo', name: 'Hi-Lo Cards', icon: 'arrow-up-down' },
                { id: 'scratch', name: 'Scratch Cards', icon: 'sparkles' },
                { id: 'coinflip', name: 'Coin Flip', icon: 'circle-dollar-sign' },
                { id: 'wheel', name: 'Wheel of Fortune', icon: 'disc' },
            ];
            const modalTemplates = {}; // FIX: Initialize modalTemplates object.

            // --- UI ELEMENT SELECTORS ---
            const authSection = document.getElementById('auth-section');
            const mainContent = document.getElementById('main-content');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const registerSuccess = document.getElementById('register-success');
            const authButtons = document.getElementById('auth-buttons');
            const userSession = document.getElementById('user-session');
            const gamesSection = document.getElementById('games');
            const modalContainer = document.getElementById('modal-container');
            const playDemoBtn = document.getElementById('play-demo-btn');
            
            // --- AUTH & UI TOGGLING FUNCTIONS ---
            const showForm = (formToShow) => {
                authSection.classList.remove('hidden');
                [loginForm, registerForm, registerSuccess].forEach(form => form.classList.add('hidden'));
                if (formToShow) formToShow.classList.remove('hidden');
            };

            const updateUIForLogin = () => {
                authSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                authButtons.classList.add('hidden');
                userSession.classList.remove('hidden');
                userSession.classList.add('flex');
                document.getElementById('username-display').textContent = currentUser.username;
                document.getElementById('dashboard-username').textContent = currentUser.username;
                updateBalanceDisplay();
            };

            const updateUIForLogout = () => {
                mainContent.classList.add('hidden');
                gamesSection.classList.add('hidden');
                authButtons.classList.remove('hidden');
                userSession.classList.add('hidden');
                userSession.classList.remove('flex');
                showForm(loginForm);
            };
            
            const updateBalanceDisplay = () => {
                 if(currentUser) {
                    const formattedBalance = currentUser.balance.toLocaleString('id-ID');
                    document.getElementById('balance-display').textContent = formattedBalance;
                    const openBalanceEl = modalContainer.querySelector('.game-balance.active-balance');
                    if (openBalanceEl) openBalanceEl.textContent = formattedBalance;
                 }
            }

            // --- CORE AUTH LOGIC & VALIDATION ---
            const checkSession = () => {
                const loggedIn = localStorage.getItem('galaxyCasinoSession');
                if (loggedIn === 'true') {
                    currentUser = JSON.parse(localStorage.getItem('galaxyCasinoUser'));
                    if (currentUser) updateUIForLogin();
                    else handleLogout();
                } else {
                    updateUIForLogout();
                }
            };

            const handleRegister = (e) => {
                e.preventDefault();
                const username = document.getElementById('register-username').value.trim();
                const phone = document.getElementById('register-phone').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const errorEl = document.getElementById('register-error');
                errorEl.textContent = ''; 

                if (localStorage.getItem('galaxyCasinoUser')) {
                    errorEl.textContent = 'Hanya 1 akun yang diizinkan per perangkat.'; return;
                }
                if (username.length < 5) {
                    errorEl.textContent = 'Username harus minimal 5 karakter.'; return;
                }
                if (!/^\d{10,13}$/.test(phone)) {
                    errorEl.textContent = 'Format nomor HP tidak valid (10-13 digit angka).'; return;
                }
                if (!/^\S+@\S+\.\S+$/.test(email)) {
                    errorEl.textContent = 'Format email tidak valid.'; return;
                }
                if (password.length < 8) {
                    errorEl.textContent = 'Password harus minimal 8 karakter.'; return;
                }

                const newUser = { username, phone, email, password, balance: 50000 };
                localStorage.setItem('galaxyCasinoUser', JSON.stringify(newUser));
                showForm(registerSuccess);
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const errorEl = document.getElementById('login-error');
                const storedUser = JSON.parse(localStorage.getItem('galaxyCasinoUser'));

                if (storedUser && storedUser.username === username && storedUser.password === password) {
                    localStorage.setItem('galaxyCasinoSession', 'true');
                    currentUser = storedUser;
                    updateUIForLogin();
                    errorEl.textContent = '';
                } else {
                    errorEl.textContent = 'Username atau password salah.';
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('galaxyCasinoSession');
                currentUser = null;
                updateUIForLogout();
            };

            const saveUserData = () => {
                if (currentUser) {
                    localStorage.setItem('galaxyCasinoUser', JSON.stringify(currentUser));
                    updateBalanceDisplay();
                }
            };

            // --- EVENT LISTENERS ---
            document.getElementById('show-login-btn').addEventListener('click', () => showForm(loginForm));
            document.getElementById('show-register-btn').addEventListener('click', () => showForm(registerForm));
            document.getElementById('switch-to-register').addEventListener('click', () => showForm(registerForm));
            document.getElementById('switch-to-login').addEventListener('click', () => showForm(loginForm));
            document.getElementById('success-login-btn').addEventListener('click', () => showForm(loginForm));
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('login-form-submit').addEventListener('submit', handleLogin);
            document.getElementById('register-form-submit').addEventListener('submit', handleRegister);
            playDemoBtn.addEventListener('click', () => {
                gamesSection.classList.remove('hidden');
                gamesSection.scrollIntoView({ behavior: 'smooth' });
            });
            
            // --- GAME & MODAL INITIALIZATION ---
            const initializeApp = () => {
                const gameGrid = gamesSection.querySelector('.grid');
                gameGrid.innerHTML = gamesData.map(game => `
                    <div class="game-card" data-game="${game.id}">
                        <i data-lucide="${game.icon}" class="w-12 h-12 text-amber-400"></i>
                        <h3 class="font-bold mt-2">${game.name}</h3>
                    </div>
                `).join('');
                
                 const baseCardClasses = "relative bg-slate-800 rounded-xl p-4 flex flex-col items-center justify-center text-center aspect-square cursor-pointer transform transition-all duration-300 hover:-translate-y-2 hover:shadow-2xl hover:shadow-amber-500/20";
                document.querySelectorAll('.game-card').forEach(card => {
                    card.className = baseCardClasses;
                    card.addEventListener('click', () => openGameModal(card.dataset.game));
                });
                
                modalContainer.innerHTML = Object.values(modalTemplates).join('');
                
                modalContainer.addEventListener('click', (e) => {
                     if (e.target.classList.contains('close-modal') || e.target === modalContainer) {
                        closeModal();
                    }
                });

                attachGameLogicListeners();

                lucide.createIcons();
                checkSession();
            };
            
            const openGameModal = (gameId) => {
                document.querySelectorAll('.modal-content').forEach(m => {
                    m.classList.add('hidden');
                    const balanceEl = m.querySelector('.game-balance');
                    if(balanceEl) balanceEl.classList.remove('active-balance');
                });

                const modal = document.getElementById(`modal-${gameId}`);
                if (modal) {
                    modalContainer.classList.remove('hidden');
                    modal.classList.remove('hidden');
                    
                    if (window[`setup_${gameId}`]) {
                        window[`setup_${gameId}`]();
                    }
                    
                    const balanceEl = modal.querySelector('.game-balance');
                    if(balanceEl) {
                        balanceEl.textContent = currentUser.balance.toLocaleString('id-ID');
                        balanceEl.classList.add('active-balance');
                    }
                    lucide.createIcons(); // Re-render icons if any were added
                }
            };
            
            let crashGameLoopId = null;
            const closeModal = () => {
                modalContainer.classList.add('hidden');
                if (crashGameLoopId) {
                    cancelAnimationFrame(crashGameLoopId);
                    crashGameLoopId = null;
                }
            };

            // --- GAME LOGIC IMPLEMENTATIONS ---
            const betInputHTML = (defaultValue = 100) => `
                <div class="flex flex-col items-center space-y-2 mt-4">
                    <label class="font-semibold">Jumlah Taruhan:</label>
                    <input type="number" class="bet-input bg-slate-700 text-white text-center rounded-lg p-2 w-40" value="${defaultValue}" min="10">
                </div>`;
            const gameBalanceHTML = `<p class="text-center mt-2">Saldo Anda: <span class="game-balance font-bold text-amber-400"></span></p>`;
            const gameResultHTML = (id, height = 'h-8') => `<p id="${id}" class="text-center ${height} my-4 font-bold text-xl"></p>`;
            const modalHeader = (title, icon) => `
                <button class="close-modal absolute top-3 right-4 text-gray-400 hover:text-white text-3xl font-bold">&times;</button>
                <h2 class="text-2xl font-bold text-amber-400 mb-4 text-center flex items-center justify-center gap-2"><i data-lucide="${icon}"></i> ${title}</h2>
            `;
            
            // --- MODAL TEMPLATES (NOW WITH FULL HTML) ---
            Object.assign(modalTemplates, {
                slot: `
                <div id="modal-slot" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-md hidden relative">
                    ${modalHeader('Slot Machine', 'gem')}
                    <div class="bg-slate-900/50 p-4 rounded-lg flex justify-center items-center space-x-4 h-32 overflow-hidden">
                        <div id="slot-reel1" class="text-5xl">💎</div>
                        <div id="slot-reel2" class="text-5xl">💎</div>
                        <div id="slot-reel3" class="text-5xl">💎</div>
                    </div>
                    ${gameResultHTML('slot-result')}
                    ${betInputHTML(100)}
                    ${gameBalanceHTML}
                    <button id="slot-spin-btn" class="w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300">Spin</button>
                </div>`,
                dice: `
                <div id="modal-dice" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-md hidden relative">
                     ${modalHeader('Dice / SicBo', 'dice-5')}
                     <div class="bg-slate-900/50 p-4 rounded-lg flex justify-center items-center space-x-4 h-24">
                        <div id="dice-1" class="text-5xl">⚅</div>
                        <div id="dice-2" class="text-5xl">⚅</div>
                        <div id="dice-3" class="text-5xl">⚅</div>
                    </div>
                    ${gameResultHTML('dice-result')}
                    <p class="text-center text-gray-400">Pilih taruhan Anda:</p>
                    <div class="flex justify-center space-x-4 mt-2">
                        <button id="dice-bet-small" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-6 rounded-lg w-1/2">Kecil (3-10)</button>
                        <button id="dice-bet-big" class="bg-red-600 hover:bg-red-700 font-bold py-2 px-6 rounded-lg w-1/2">Besar (11-18)</button>
                    </div>
                    ${betInputHTML(50)}
                    ${gameBalanceHTML}
                </div>`,
                blackjack: `
                <div id="modal-blackjack" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-lg hidden relative">
                    ${modalHeader('Blackjack', 'spade')}
                    <div class="bg-green-800/50 p-4 rounded-lg min-h-[250px] space-y-4"><div><h3 class="font-bold">Dealer (<span id="dealer-score">0</span>)</h3><div id="dealer-cards" class="flex space-x-2 mt-1 h-20"></div></div><div><h3 class="font-bold">Pemain (<span id="player-score">0</span>)</h3><div id="player-cards" class="flex space-x-2 mt-1 h-20"></div></div></div>
                    ${gameResultHTML('blackjack-result')}
                    <div id="blackjack-controls" class="flex justify-center space-x-4"><button id="bj-hit" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-6 rounded-lg">Hit</button><button id="bj-stand" class="bg-yellow-600 hover:bg-yellow-700 font-bold py-2 px-6 rounded-lg">Stand</button></div>
                    <button id="bj-new-game" class="hidden w-full mt-4 bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-2 px-6 rounded-lg">Game Baru</button>
                    ${betInputHTML(100)}
                    ${gameBalanceHTML}
                </div>`,
                keno: `
                <div id="modal-keno" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-2xl hidden relative">
                    ${modalHeader('Keno', 'app-window')}
                    <div id="keno-grid" class="grid grid-cols-10 gap-1 my-4"></div>
                    <p class="text-center text-sm text-gray-400">Pilih 2 hingga 10 angka.</p>
                    ${gameResultHTML('keno-result')}
                    <button id="keno-draw-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg uppercase transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Mulai Draw</button>
                    <button id="keno-reset-btn" class="w-full mt-2 bg-slate-600 hover:bg-slate-700 font-bold py-2 px-6 rounded-lg">Pilih Ulang</button>
                    ${betInputHTML(20)}
                    ${gameBalanceHTML}
                </div>`,
                crash: `
                <div id="modal-crash" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-lg hidden relative">
                    ${modalHeader('Crash Game', 'trending-up')}
                    <div class="relative bg-slate-900 rounded-lg h-64 p-2">
                        <canvas id="crash-canvas"></canvas>
                        <div id="crash-multiplier-display" class="absolute inset-0 flex items-center justify-center text-5xl font-black text-white" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.7);">1.00x</div>
                    </div>
                    ${gameResultHTML('crash-result')}
                    <button id="crash-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300">Mulai</button>
                    ${betInputHTML(100)}
                    ${gameBalanceHTML}
                </div>`,
                 coinflip: `
                <div id="modal-coinflip" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-md hidden relative">
                    ${modalHeader('Coin Flip', 'circle-dollar-sign')}
                    <div class="flex justify-center items-center h-32">
                        <div id="coinflip-coin" class="text-7xl">🪙</div>
                    </div>
                    ${gameResultHTML('coinflip-result')}
                    <div class="flex justify-center space-x-4 mt-2">
                        <button id="coinflip-heads" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-6 rounded-lg w-1/2">Kepala</button>
                        <button id="coinflip-tails" class="bg-red-600 hover:bg-red-700 font-bold py-2 px-6 rounded-lg w-1/2">Ekor</button>
                    </div>
                    ${betInputHTML(50)}
                    ${gameBalanceHTML}
                </div>`,
                roulette: `
                <div id="modal-roulette" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-lg hidden relative">
                    ${modalHeader('Roulette', 'circle-dashed')}
                    <div class="bg-slate-900/50 rounded-full w-48 h-48 mx-auto flex items-center justify-center mb-4">
                        <span id="roulette-result-number" class="text-5xl font-bold">0</span>
                    </div>
                    ${gameResultHTML('roulette-result-text')}
                    <div class="grid grid-cols-2 gap-2">
                        <button class="roulette-bet-btn bg-red-700 hover:bg-red-800 font-bold py-3 rounded-lg" data-bet="red">Merah</button>
                        <button class="roulette-bet-btn bg-slate-900 hover:bg-slate-950 text-white font-bold py-3 rounded-lg" data-bet="black">Hitam</button>
                        <button class="roulette-bet-btn bg-green-700 hover:bg-green-800 font-bold py-3 rounded-lg" data-bet="even">Genap</button>
                        <button class="roulette-bet-btn bg-green-700 hover:bg-green-800 font-bold py-3 rounded-lg" data-bet="odd">Ganjil</button>
                    </div>
                    ${betInputHTML(100)}
                    ${gameBalanceHTML}
                </div>`,
                baccarat: `
                <div id="modal-baccarat" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-lg hidden relative">
                     ${modalHeader('Baccarat', 'user-square-2')}
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <h3 class="font-bold text-lg">PLAYER (<span id="baccarat-player-score">0</span>)</h3>
                            <div id="baccarat-player-cards" class="flex justify-center space-x-2 mt-2 h-20"></div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg">BANKER (<span id="baccarat-banker-score">0</span>)</h3>
                            <div id="baccarat-banker-cards" class="flex justify-center space-x-2 mt-2 h-20"></div>
                        </div>
                    </div>
                     ${gameResultHTML('baccarat-result')}
                     <div class="grid grid-cols-3 gap-2 mt-4">
                        <button class="baccarat-bet-btn bg-blue-700 hover:bg-blue-800 font-bold py-3 rounded-lg" data-bet="player">Player</button>
                        <button class="baccarat-bet-btn bg-gray-600 hover:bg-gray-700 font-bold py-3 rounded-lg" data-bet="tie">Tie</button>
                        <button class="baccarat-bet-btn bg-red-700 hover:bg-red-800 font-bold py-3 rounded-lg" data-bet="banker">Banker</button>
                     </div>
                     ${betInputHTML(100)}
                     ${gameBalanceHTML}
                </div>`,
                poker: `
                <div id="modal-poker" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-2xl hidden relative">
                    ${modalHeader('Video Poker', 'layers')}
                    <div id="poker-hand" class="flex justify-center space-x-2 mt-2 h-[100px]"></div>
                    <div class="text-center mt-2 h-4 text-xs text-amber-400">Klik kartu untuk menahan (Hold)</div>
                    ${gameResultHTML('poker-result')}
                    <button id="poker-deal-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">DEAL</button>
                    <button id="poker-draw-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg hidden">DRAW</button>
                     ${betInputHTML(50)}
                     ${gameBalanceHTML}
                </div>`,
                hilo: `
                <div id="modal-hilo" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-md hidden relative">
                    ${modalHeader('Hi-Lo Cards', 'arrow-up-down')}
                    <div class="flex justify-around items-center h-32">
                        <div>
                            <p class="text-center font-bold">Kartu Saat Ini</p>
                            <div id="hilo-current-card" class="card"></div>
                        </div>
                        <div>
                             <p class="text-center font-bold">Kartu Berikutnya</p>
                            <div id="hilo-next-card" class="card hidden-card">?</div>
                        </div>
                    </div>
                    ${gameResultHTML('hilo-result')}
                     <div class="flex justify-center space-x-4 mt-2">
                        <button id="hilo-high-btn" class="bg-green-600 hover:bg-green-700 font-bold py-2 px-6 rounded-lg w-1/2">Lebih Tinggi</button>
                        <button id="hilo-low-btn" class="bg-red-600 hover:bg-red-700 font-bold py-2 px-6 rounded-lg w-1/2">Lebih Rendah</button>
                    </div>
                    ${betInputHTML(50)}
                    ${gameBalanceHTML}
                </div>`,
                scratch: `
                <div id="modal-scratch" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-md hidden relative">
                     ${modalHeader('Scratch Cards', 'sparkles')}
                    <div id="scratch-grid" class="grid grid-cols-3 gap-2 bg-slate-900 p-2 rounded-lg aspect-square"></div>
                     ${gameResultHTML('scratch-result')}
                    <button id="scratch-new-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">Beli Kartu Baru</button>
                     ${betInputHTML(25)}
                     ${gameBalanceHTML}
                </div>`,
                wheel: `
                <div id="modal-wheel" class="modal-content bg-slate-800 p-6 rounded-lg shadow-2xl w-full max-w-lg hidden relative">
                     ${modalHeader('Wheel of Fortune', 'disc')}
                    <div class="relative flex justify-center items-center my-4">
                        <div class="absolute text-amber-400 text-4xl top-[-20px] z-10">▼</div>
                        <canvas id="wheelCanvas" width="300" height="300"></canvas>
                    </div>
                     ${gameResultHTML('wheel-result')}
                    <button id="wheel-spin-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 rounded-lg">PUTAR</button>
                     ${betInputHTML(100)}
                     ${gameBalanceHTML}
                </div>`,
            });
            
            // --- ATTACH ALL GAME LOGIC LISTENERS ---
            function attachGameLogicListeners() {
                // Shared card logic
                const suits = ['♥', '♦', '♣', '♠'];
                const values = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
                
                const createDeck = () => {
                    return suits.flatMap(suit => values.map(value => ({ suit, value })));
                };

                const shuffleDeck = (deck) => {
                    for (let i = deck.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [deck[i], deck[j]] = [deck[j], deck[i]];
                    }
                    return deck;
                };

                const getCardValue = (card) => {
                    if (['J', 'Q', 'K'].includes(card.value)) return 10;
                    if (card.value === 'A') return 11;
                    return parseInt(card.value);
                };
                
                const createCardElement = (card, isHidden = false) => {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'card';
                    if (isHidden) {
                        cardEl.classList.add('hidden-card');
                        cardEl.innerHTML = '';
                    } else {
                        cardEl.innerHTML = `${card.value}<br>${card.suit}`;
                        if (['♥', '♦'].includes(card.suit)) {
                            cardEl.classList.add('red');
                        }
                    }
                    return cardEl;
                };
                
                // --- SLOT MACHINE LOGIC ---
                window.setup_slot = () => {
                    document.getElementById('slot-result').textContent = '';
                };
                document.getElementById('slot-spin-btn').addEventListener('click', () => {
                    const bet = parseInt(document.querySelector('#modal-slot .bet-input').value);
                    const resultEl = document.getElementById('slot-result');
                    const spinBtn = document.getElementById('slot-spin-btn');
                    if (currentUser.balance < bet) { resultEl.textContent = "Saldo tidak cukup!"; return; }
                    
                    currentUser.balance -= bet;
                    saveUserData();
                    resultEl.textContent = "";
                    spinBtn.disabled = true;
                    const reels = [document.getElementById('slot-reel1'), document.getElementById('slot-reel2'), document.getElementById('slot-reel3')];
                    const symbols = ['💎', '🍒', '🍋', '🔔', '💰', '⭐'];
                    let finalResults = [];

                    reels.forEach((reel, i) => {
                        setTimeout(() => {
                            const interval = setInterval(() => { reel.textContent = symbols[Math.floor(Math.random() * symbols.length)]; }, 100);
                            setTimeout(() => {
                                clearInterval(interval);
                                const finalSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                                reel.textContent = finalSymbol;
                                finalResults.push(finalSymbol);
                                if (i === reels.length - 1) { // Last reel
                                    if (finalResults[0] === finalResults[1] && finalResults[1] === finalResults[2]) {
                                        const winnings = bet * 10;
                                        currentUser.balance += winnings;
                                        resultEl.textContent = `JACKPOT! Anda menang ${winnings.toLocaleString('id-ID')}!`;
                                    } else {
                                        resultEl.textContent = "Coba lagi!";
                                    }
                                    saveUserData();
                                    spinBtn.disabled = false;
                                }
                            }, 1000 + i * 500);
                        }, i * 200);
                    });
                });

                // --- DICE/SICBO LOGIC ---
                window.setup_dice = () => {
                     document.getElementById('dice-result').textContent = '';
                };
                const handleDiceBet = (betType) => {
                    const bet = parseInt(document.querySelector('#modal-dice .bet-input').value);
                    const resultEl = document.getElementById('dice-result');
                    if (currentUser.balance < bet) { resultEl.textContent = "Saldo tidak cukup!"; return; }
                    currentUser.balance -= bet;
                    const diceEmojis = ['⚀', '⚁', '⚂', '⚃', '⚄', '⚅'];
                    const d1 = Math.floor(Math.random() * 6) + 1;
                    const d2 = Math.floor(Math.random() * 6) + 1;
                    const d3 = Math.floor(Math.random() * 6) + 1;
                    const total = d1 + d2 + d3;
                    document.getElementById('dice-1').textContent = diceEmojis[d1 - 1];
                    document.getElementById('dice-2').textContent = diceEmojis[d2 - 1];
                    document.getElementById('dice-3').textContent = diceEmojis[d3 - 1];
                    const resultType = (total >= 3 && total <= 10) ? 'small' : 'big';
                    if (betType === resultType) {
                        const winnings = bet * 2;
                        currentUser.balance += winnings;
                        resultEl.textContent = `Total ${total}: Anda menang ${winnings.toLocaleString('id-ID')}!`;
                    } else {
                        resultEl.textContent = `Total ${total}: Anda kalah.`;
                    }
                    saveUserData();
                };
                document.getElementById('dice-bet-small').addEventListener('click', () => handleDiceBet('small'));
                document.getElementById('dice-bet-big').addEventListener('click', () => handleDiceBet('big'));

                // --- BLACKJACK LOGIC ---
                let bjDeck, bjPlayerHand, bjDealerHand, bjPlayerScore, bjDealerScore, bjBet;
                const bjResultEl = document.getElementById('blackjack-result');
                const startBlackjack = () => {
                    bjBet = parseInt(document.querySelector('#modal-blackjack .bet-input').value);
                    if (currentUser.balance < bjBet) { bjResultEl.textContent = "Saldo tidak cukup!"; return; }
                    currentUser.balance -= bjBet;
                    saveUserData();

                    bjDeck = shuffleDeck(createDeck());
                    bjPlayerHand = [bjDeck.pop(), bjDeck.pop()];
                    bjDealerHand = [bjDeck.pop(), bjDeck.pop()];
                    
                    document.getElementById('blackjack-controls').classList.remove('hidden');
                    document.getElementById('bj-new-game').classList.add('hidden');
                    document.querySelector('#modal-blackjack .bet-input').parentElement.classList.add('hidden');
                    bjResultEl.textContent = '';
                    
                    renderBlackjackHands();
                    checkBlackjack();
                };
                const renderBlackjackHands = (revealDealer = false) => {
                    const playerHandEl = document.getElementById('player-cards');
                    const dealerHandEl = document.getElementById('dealer-cards');
                    playerHandEl.innerHTML = '';
                    dealerHandEl.innerHTML = '';
                    bjPlayerHand.forEach(card => playerHandEl.appendChild(createCardElement(card)));
                    bjDealerHand.forEach((card, i) => {
                        dealerHandEl.appendChild(createCardElement(card, i === 0 && !revealDealer));
                    });
                    bjPlayerScore = calculateHandScore(bjPlayerHand);
                    bjDealerScore = calculateHandScore(bjDealerHand, revealDealer);
                    document.getElementById('player-score').textContent = bjPlayerScore;
                    document.getElementById('dealer-score').textContent = revealDealer ? bjDealerScore : getCardValue(bjDealerHand[1]);
                };
                const calculateHandScore = (hand, countAll = true) => {
                    let score = 0;
                    let aces = 0;
                    hand.forEach((card, i) => {
                        if (!countAll && i === 0) return;
                        score += getCardValue(card);
                        if (card.value === 'A') aces++;
                    });
                    while (score > 21 && aces > 0) {
                        score -= 10;
                        aces--;
                    }
                    return score;
                };
                const checkBlackjack = () => {
                    if (bjPlayerScore === 21) {
                        endBlackjack('Pemain Blackjack! Anda menang!', bjBet * 2.5);
                    }
                };
                const endBlackjack = (message, winnings = 0) => {
                    renderBlackjackHands(true);
                    currentUser.balance += winnings;
                    bjResultEl.textContent = message;
                    saveUserData();
                    document.getElementById('blackjack-controls').classList.add('hidden');
                    document.getElementById('bj-new-game').classList.remove('hidden');
                    document.querySelector('#modal-blackjack .bet-input').parentElement.classList.remove('hidden');
                };
                document.getElementById('bj-hit').addEventListener('click', () => {
                    bjPlayerHand.push(bjDeck.pop());
                    renderBlackjackHands();
                    if (bjPlayerScore > 21) {
                        endBlackjack('Bust! Anda kalah.');
                    }
                });
                document.getElementById('bj-stand').addEventListener('click', () => {
                    renderBlackjackHands(true);
                    while (bjDealerScore < 17) {
                        bjDealerHand.push(bjDeck.pop());
                        bjDealerScore = calculateHandScore(bjDealerHand);
                    }
                    renderBlackjackHands(true);
                    if (bjDealerScore > 21 || bjPlayerScore > bjDealerScore) {
                        endBlackjack('Anda Menang!', bjBet * 2);
                    } else if (bjDealerScore > bjPlayerScore) {
                        endBlackjack('Dealer Menang.');
                    } else {
                        endBlackjack('Push (Seri).', bjBet);
                    }
                });
                window.setup_blackjack = () => {
                    startBlackjack();
                }
                document.getElementById('bj-new-game').addEventListener('click', startBlackjack);

                // --- KENO LOGIC ---
                let kenoSelected = [];
                const kenoGrid = document.getElementById('keno-grid');
                const kenoDrawBtn = document.getElementById('keno-draw-btn');
                const kenoResultEl = document.getElementById('keno-result');
                
                const setup_keno = () => {
                    kenoGrid.innerHTML = '';
                    kenoSelected = [];
                    kenoResultEl.textContent = '';
                    kenoDrawBtn.disabled = true;
                    for (let i = 1; i <= 80; i++) {
                        const ball = document.createElement('div');
                        ball.className = 'keno-ball border-2 border-slate-600 rounded-full flex items-center justify-center aspect-square cursor-pointer';
                        ball.textContent = i;
                        ball.dataset.number = i;
                        ball.addEventListener('click', () => {
                            if(kenoGrid.classList.contains('drawing')) return;
                            const num = parseInt(ball.dataset.number);
                            if (kenoSelected.includes(num)) {
                                kenoSelected = kenoSelected.filter(n => n !== num);
                                ball.classList.remove('selected');
                            } else if (kenoSelected.length < 10) {
                                kenoSelected.push(num);
                                ball.classList.add('selected');
                            }
                            kenoDrawBtn.disabled = kenoSelected.length < 2;
                        });
                        kenoGrid.appendChild(ball);
                    }
                    kenoGrid.classList.remove('drawing');
                };
                window.setup_keno = setup_keno;
                document.getElementById('keno-reset-btn').addEventListener('click', setup_keno);
                kenoDrawBtn.addEventListener('click', () => {
                    const bet = parseInt(document.querySelector('#modal-keno .bet-input').value);
                    if (currentUser.balance < bet) { kenoResultEl.textContent = "Saldo tidak cukup!"; return; }
                    currentUser.balance -= bet;
                    saveUserData();
                    kenoDrawBtn.disabled = true;
                    kenoGrid.classList.add('drawing');
                    
                    let drawnNumbers = new Set();
                    while(drawnNumbers.size < 20) {
                        drawnNumbers.add(Math.floor(Math.random() * 80) + 1);
                    }
                    
                    let matches = 0;
                    drawnNumbers.forEach((num, i) => {
                        setTimeout(() => {
                           const ball = kenoGrid.querySelector(`[data-number="${num}"]`);
                           ball.classList.add('drawn');
                           if(kenoSelected.includes(num)) {
                               ball.classList.add('match');
                               matches++;
                           }
                           if (i === 19) { // Last number drawn
                                const payout = {2:[0,0,3], 3:[0,0,1,10], 10:[0,0,0,0,1,2,5,20,100,500,1500]};
                                const winMulti = (payout[kenoSelected.length] && payout[kenoSelected.length][matches]) || 0;
                                const winnings = bet * winMulti;
                                if(winnings > 0) {
                                    currentUser.balance += winnings;
                                    kenoResultEl.textContent = `Cocok ${matches}! Anda menang ${winnings.toLocaleString('id-ID')}!`;
                                } else {
                                    kenoResultEl.textContent = `Cocok ${matches}. Coba lagi.`;
                                }
                                saveUserData();
                           }
                        }, i * 100);
                    });
                });
                
                // --- CRASH LOGIC ---
                const crashCanvas = document.getElementById('crash-canvas');
                const crashCtx = crashCanvas.getContext('2d');
                const multiplierEl = document.getElementById('crash-multiplier-display');
                const crashBtn = document.getElementById('crash-btn');
                const crashResultEl = document.getElementById('crash-result');
                let multiplier, crashPoint, gameState; // ready, playing, crashed
                
                const drawCrashGraph = () => {
                    crashCtx.clearRect(0, 0, crashCanvas.width, crashCanvas.height);
                    crashCtx.beginPath();
                    crashCtx.moveTo(0, crashCanvas.height);
                    const plotX = (multiplier - 1) * (crashCanvas.width / 5);
                    const plotY = crashCanvas.height - Math.log(multiplier) * (crashCanvas.height / 2);
                    crashCtx.lineTo(plotX, plotY);
                    crashCtx.strokeStyle = '#F59E0B';
                    crashCtx.lineWidth = 4;
                    crashCtx.stroke();
                };

                const crashGameLoop = () => {
                    multiplier += 0.01;
                    multiplierEl.textContent = `${multiplier.toFixed(2)}x`;
                    drawCrashGraph();
                    if (multiplier >= crashPoint) {
                        gameState = 'crashed';
                        cancelAnimationFrame(crashGameLoopId);
                        crashGameLoopId = null;
                        multiplierEl.style.color = '#EF4444'; // red-500
                        crashResultEl.textContent = `CRASH di ${crashPoint.toFixed(2)}x!`;
                        crashBtn.textContent = 'Mulai Lagi';
                        crashBtn.className = "w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300";
                    } else {
                        crashGameLoopId = requestAnimationFrame(crashGameLoop);
                    }
                };

                window.setup_crash = () => {
                    crashCanvas.width = crashCanvas.parentElement.clientWidth;
                    crashCanvas.height = crashCanvas.parentElement.clientHeight;
                    gameState = 'ready';
                    multiplier = 1.00;
                    crashResultEl.textContent = '';
                    multiplierEl.textContent = '1.00x';
                    multiplierEl.style.color = 'white';
                    crashBtn.textContent = 'Mulai';
                    crashBtn.className = "w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300";
                    drawCrashGraph();
                };

                crashBtn.addEventListener('click', () => {
                    const bet = parseInt(document.querySelector('#modal-crash .bet-input').value);
                    if (gameState === 'ready' || gameState === 'crashed') {
                        if (currentUser.balance < bet) { crashResultEl.textContent = "Saldo tidak cukup!"; return; }
                        currentUser.balance -= bet;
                        saveUserData();
                        
                        gameState = 'playing';
                        multiplier = 1.00;
                        crashPoint = 1 + Math.pow(Math.random(), 3) * 20;
                        crashResultEl.textContent = '';
                        multiplierEl.style.color = 'white';
                        crashBtn.textContent = 'Cash Out';
                        crashBtn.className = "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300";
                        crashGameLoop();
                    } else if (gameState === 'playing') {
                        gameState = 'crashed';
                        cancelAnimationFrame(crashGameLoopId);
                        crashGameLoopId = null;
                        const winnings = bet * multiplier;
                        currentUser.balance += winnings;
                        saveUserData();
                        crashResultEl.textContent = `Anda Cash Out di ${multiplier.toFixed(2)}x! Menang ${winnings.toLocaleString('id-ID')}!`;
                        multiplierEl.style.color = '#22C55E'; // green-500
                        crashBtn.textContent = 'Mulai Lagi';
                        crashBtn.className = "w-full bg-amber-500 hover:bg-amber-600 text-slate-900 font-bold py-3 px-8 rounded-lg text-lg uppercase transition duration-300";
                    }
                });
                
                // --- COIN FLIP LOGIC ---
                window.setup_coinflip = () => {
                    document.getElementById('coinflip-result').textContent = '';
                };
                const handleCoinFlip = (choice) => {
                    const bet = parseInt(document.querySelector('#modal-coinflip .bet-input').value);
                    const resultEl = document.getElementById('coinflip-result');
                    const coinEl = document.getElementById('coinflip-coin');
                     if (currentUser.balance < bet) { resultEl.textContent = "Saldo tidak cukup!"; return; }
                     currentUser.balance -= bet;
                     const result = Math.random() < 0.5 ? 'heads' : 'tails';
                     
                     coinEl.textContent = result === 'heads' ? '👑' : '🪙';
                     
                     if (choice === result) {
                         const winnings = bet * 2;
                         currentUser.balance += winnings;
                         resultEl.textContent = `Anda menang ${winnings.toLocaleString('id-ID')}!`;
                     } else {
                         resultEl.textContent = 'Anda kalah.';
                     }
                     saveUserData();
                };
                document.getElementById('coinflip-heads').addEventListener('click', () => handleCoinFlip('heads'));
                document.getElementById('coinflip-tails').addEventListener('click', () => handleCoinFlip('tails'));
                
                // --- ROULETTE LOGIC ---
                const redNumbers = [1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36];
                window.setup_roulette = () => {
                    document.getElementById('roulette-result-text').textContent = '';
                };
                document.querySelectorAll('.roulette-bet-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const bet = parseInt(document.querySelector('#modal-roulette .bet-input').value);
                        const resultTextEl = document.getElementById('roulette-result-text');
                        if(currentUser.balance < bet) { resultTextEl.textContent = 'Saldo tidak cukup!'; return; }
                        currentUser.balance -= bet;
                        
                        const winningNumber = Math.floor(Math.random() * 37); // 0-36
                        document.getElementById('roulette-result-number').textContent = winningNumber;

                        const betType = e.target.dataset.bet;
                        let isWin = false;
                        if(betType === 'red' && redNumbers.includes(winningNumber)) isWin = true;
                        if(betType === 'black' && !redNumbers.includes(winningNumber) && winningNumber !== 0) isWin = true;
                        if(betType === 'even' && winningNumber % 2 === 0 && winningNumber !== 0) isWin = true;
                        if(betType === 'odd' && winningNumber % 2 !== 0 && winningNumber !== 0) isWin = true;

                        if(isWin) {
                            const winnings = bet * 2;
                            currentUser.balance += winnings;
                            resultTextEl.textContent = `Menang ${winnings.toLocaleString('id-ID')}!`;
                        } else {
                             resultTextEl.textContent = 'Kalah. Coba lagi.';
                        }
                        saveUserData();
                    });
                });
                
                // --- BACCARAT LOGIC ---
                const getBaccaratCardValue = (card) => {
                    if (['10', 'J', 'Q', 'K'].includes(card.value)) return 0;
                    if (card.value === 'A') return 1;
                    return parseInt(card.value);
                };
                window.setup_baccarat = () => {
                    document.getElementById('baccarat-result').textContent = '';
                    document.getElementById('baccarat-player-cards').innerHTML = '';
                    document.getElementById('baccarat-banker-cards').innerHTML = '';
                    document.getElementById('baccarat-player-score').textContent = '0';
                    document.getElementById('baccarat-banker-score').textContent = '0';
                };
                document.querySelectorAll('.baccarat-bet-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const bet = parseInt(document.querySelector('#modal-baccarat .bet-input').value);
                        const resultEl = document.getElementById('baccarat-result');
                        if(currentUser.balance < bet) { resultEl.textContent = 'Saldo tidak cukup!'; return; }
                        currentUser.balance -= bet;

                        let deck = shuffleDeck(createDeck());
                        let playerCards = [deck.pop(), deck.pop()];
                        let bankerCards = [deck.pop(), deck.pop()];
                        
                        const calculateScore = (hand) => (hand.reduce((acc, card) => acc + getBaccaratCardValue(card), 0)) % 10;
                        let playerScore = calculateScore(playerCards);
                        let bankerScore = calculateScore(bankerCards);

                        // Third card rules
                        if (playerScore <= 5) playerCards.push(deck.pop());
                        playerScore = calculateScore(playerCards);
                        // Complex banker third card rule simplified for this demo
                        if (bankerScore <= 5) bankerCards.push(deck.pop());
                        bankerScore = calculateScore(bankerCards);
                        
                        document.getElementById('baccarat-player-cards').innerHTML = '';
                        playerCards.forEach(c => document.getElementById('baccarat-player-cards').appendChild(createCardElement(c)));
                        document.getElementById('baccarat-banker-cards').innerHTML = '';
                        bankerCards.forEach(c => document.getElementById('baccarat-banker-cards').appendChild(createCardElement(c)));

                        document.getElementById('baccarat-player-score').textContent = playerScore;
                        document.getElementById('baccarat-banker-score').textContent = bankerScore;
                        
                        const betOn = e.target.dataset.bet;
                        let winner = '';
                        if(playerScore > bankerScore) winner = 'player';
                        else if (bankerScore > playerScore) winner = 'banker';
                        else winner = 'tie';

                        if(betOn === winner) {
                            const multiplier = betOn === 'tie' ? 9 : 2;
                            const winnings = bet * multiplier;
                            currentUser.balance += winnings;
                            resultEl.textContent = `${winner.toUpperCase()} menang! Anda dapat ${winnings.toLocaleString('id-ID')}.`;
                        } else {
                            resultEl.textContent = `${winner.toUpperCase()} menang. Anda kalah.`;
                        }
                        saveUserData();
                    });
                });
                
                // --- VIDEO POKER LOGIC ---
                let pokerHand, pokerDeck, pokerStage;
                const pokerResultEl = document.getElementById('poker-result');
                const pokerHandEl = document.getElementById('poker-hand');
                
                const evaluatePokerHand = (hand) => {
                    const ranks = '23456789TJQKA'.split(''); // T for 10
                    const rankCount = {};
                    hand.forEach(card => {
                        const r = card.value === '10' ? 'T' : card.value[0];
                        rankCount[r] = (rankCount[r] || 0) + 1;
                    });
                    const pairs = Object.values(rankCount).filter(c => c === 2).length;
                    const trips = Object.values(rankCount).filter(c => c === 3).length;
                    const quads = Object.values(rankCount).filter(c => c === 4).length;
                    
                    if (pairs === 1 && trips === 1) return { hand: "Full House", mult: 6 };
                    if (quads === 1) return { hand: "Four of a Kind", mult: 25 };
                    if (trips === 1) return { hand: "Three of a Kind", mult: 3 };
                    if (pairs === 2) return { hand: "Two Pair", mult: 2 };
                    const hasJacksOrBetter = ['J', 'Q', 'K', 'A'].some(rank => rankCount[rank] === 2);
                    if (pairs === 1 && hasJacksOrBetter) return { hand: "Jacks or Better", mult: 1 };
                    
                    return { hand: "High Card", mult: 0 };
                };
                
                const startPoker = () => {
                     const bet = parseInt(document.querySelector('#modal-poker .bet-input').value);
                     if (currentUser.balance < bet) { pokerResultEl.textContent = "Saldo tidak cukup!"; return; }
                     currentUser.balance -= bet;
                     saveUserData();

                     pokerDeck = shuffleDeck(createDeck());
                     pokerHand = [];
                     for(let i=0; i<5; i++) pokerHand.push(pokerDeck.pop());
                     pokerStage = 'deal';
                     renderPokerHand();
                     document.getElementById('poker-deal-btn').classList.add('hidden');
                     document.getElementById('poker-draw-btn').classList.remove('hidden');
                     pokerResultEl.textContent = '';
                };

                const renderPokerHand = () => {
                    pokerHandEl.innerHTML = '';
                    pokerHand.forEach((card, index) => {
                        const cardEl = createCardElement(card);
                        cardEl.dataset.index = index;
                        if(card.held) cardEl.style.border = '2px solid #F59E0B';
                        cardEl.addEventListener('click', () => {
                            if(pokerStage !== 'deal') return;
                            card.held = !card.held;
                            renderPokerHand();
                        });
                        pokerHandEl.appendChild(cardEl);
                    });
                };
                
                window.setup_poker = () => {
                    pokerStage = 'end';
                    document.getElementById('poker-deal-btn').classList.remove('hidden');
                    document.getElementById('poker-draw-btn').classList.add('hidden');
                    pokerHandEl.innerHTML = '';
                    pokerResultEl.textContent = '';
                };
                document.getElementById('poker-deal-btn').addEventListener('click', startPoker);
                document.getElementById('poker-draw-btn').addEventListener('click', () => {
                    const bet = parseInt(document.querySelector('#modal-poker .bet-input').value);
                    pokerHand.forEach((card, i) => {
                        if (!card.held) {
                            pokerHand[i] = pokerDeck.pop();
                        }
                    });
                    pokerStage = 'end';
                    renderPokerHand();
                    
                    const result = evaluatePokerHand(pokerHand);
                    const winnings = bet * result.mult;
                    if(winnings > 0) {
                        currentUser.balance += winnings;
                        pokerResultEl.textContent = `${result.hand}! Anda menang ${winnings.toLocaleString('id-ID')}!`;
                    } else {
                        pokerResultEl.textContent = `Tidak ada kombinasi. Coba lagi.`;
                    }
                    saveUserData();

                    document.getElementById('poker-deal-btn').classList.remove('hidden');
                    document.getElementById('poker-draw-btn').classList.add('hidden');
                });
                
                // --- HI-LO LOGIC ---
                let hiloCurrentCard, hiloDeck;
                const rankOrder = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];

                window.setup_hilo = () => {
                    hiloDeck = shuffleDeck(createDeck());
                    hiloCurrentCard = hiloDeck.pop();
                    document.getElementById('hilo-current-card').replaceWith(createCardElement(hiloCurrentCard));
                    document.getElementById('hilo-current-card').id = 'hilo-current-card';
                    document.getElementById('hilo-next-card').classList.add('hidden-card');
                    document.getElementById('hilo-next-card').textContent = '?';
                    document.getElementById('hilo-result').textContent = '';
                    document.getElementById('hilo-high-btn').disabled = false;
                    document.getElementById('hilo-low-btn').disabled = false;
                };
                
                const handleHilo = (choice) => {
                    const bet = parseInt(document.querySelector('#modal-hilo .bet-input').value);
                    const resultEl = document.getElementById('hilo-result');
                    if(currentUser.balance < bet) { resultEl.textContent = 'Saldo tidak cukup!'; return; }
                    currentUser.balance -= bet;

                    const nextCard = hiloDeck.pop();
                    document.getElementById('hilo-next-card').replaceWith(createCardElement(nextCard));
                    document.getElementById('hilo-next-card').id = 'hilo-next-card';
                    
                    const currentRank = rankOrder.indexOf(hiloCurrentCard.value);
                    const nextRank = rankOrder.indexOf(nextCard.value);

                    let result = '';
                    if (nextRank > currentRank) result = 'high';
                    else if (nextRank < currentRank) result = 'low';
                    else result = choice; // win on same rank

                    if (choice === result) {
                        const winnings = bet * 2;
                        currentUser.balance += winnings;
                        resultEl.textContent = `Benar! Anda menang ${winnings.toLocaleString('id-ID')}!`;
                    } else {
                        resultEl.textContent = 'Salah. Coba lagi.';
                    }
                    saveUserData();
                    hiloCurrentCard = nextCard;
                    document.getElementById('hilo-high-btn').disabled = true;
                    document.getElementById('hilo-low-btn').disabled = true;
                    setTimeout(window.setup_hilo, 2000);
                };
                document.getElementById('hilo-high-btn').addEventListener('click', () => handleHilo('high'));
                document.getElementById('hilo-low-btn').addEventListener('click', () => handleHilo('low'));

                // --- SCRATCH CARD LOGIC ---
                const setup_scratch = () => {
                    const bet = parseInt(document.querySelector('#modal-scratch .bet-input').value);
                    const resultEl = document.getElementById('scratch-result');
                    if(currentUser.balance < bet) { resultEl.textContent = 'Saldo tidak cukup!'; return; }
                    currentUser.balance -= bet;
                    saveUserData();
                    resultEl.textContent = 'Gores untuk melihat hadiah!';

                    const grid = document.getElementById('scratch-grid');
                    grid.innerHTML = '';
                    const symbols = ['🍒', '🍋', '🔔', '💰', '⭐', '💎'];
                    const prizeSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                    let cardSymbols = [prizeSymbol, prizeSymbol, prizeSymbol];
                    while(cardSymbols.length < 9) {
                        cardSymbols.push(symbols[Math.floor(Math.random() * symbols.length)]);
                    }
                    shuffleDeck(cardSymbols);

                    let revealedCount = 0;
                    cardSymbols.forEach(symbol => {
                        const cell = document.createElement('div');
                        cell.className = 'relative w-full h-full';
                        cell.innerHTML = `
                            <div class="absolute inset-0 flex items-center justify-center text-4xl">${symbol}</div>
                            <div class="scratch-card-cover absolute inset-0 bg-slate-500"></div>`;
                        cell.querySelector('.scratch-card-cover').addEventListener('click', (e) => {
                            e.target.style.opacity = '0';
                            revealedCount++;
                            if(revealedCount === 9) {
                                const counts = {};
                                cardSymbols.forEach(s => counts[s] = (counts[s] || 0) + 1);
                                const match = Object.values(counts).find(c => c >= 3);
                                if(match) {
                                    const winnings = bet * 5;
                                    currentUser.balance += winnings;
                                    resultEl.textContent = `Anda menang ${winnings.toLocaleString('id-ID')}!`;
                                } else {
                                    resultEl.textContent = 'Tidak ada kemenangan. Coba lagi.';
                                }
                                saveUserData();
                            }
                        }, {once: true});
                        grid.appendChild(cell);
                    });
                };
                window.setup_scratch = setup_scratch;
                document.getElementById('scratch-new-btn').addEventListener('click', setup_scratch);

                // --- WHEEL OF FORTUNE LOGIC (UPDATED) ---
                const wheelCanvas = document.getElementById('wheelCanvas');
                const wheelCtx = wheelCanvas.getContext('2d');
                // [MODIFIED] New segments with negative (loss) values
                const segments = [
                    { color: '#10B981', label: '1x' },  // Green
                    { color: '#3B82F6', label: '3x' },  // Blue
                    { color: '#F59E0B', label: '2x' },  // Amber
                    { color: '#6366F1', label: '5x' },  // Indigo
                    { color: '#DC2626', label: '-5x'}, // Red (loss)
                    { color: '#EC4899', label: '10x'}, // Pink (big win)
                    { color: '#9333EA', label: '-3x' }, // Purple (loss)
                    { color: '#EF4444', label: '-2x' }  // Lighter Red (loss)
                ];
                const segmentAngle = (2 * Math.PI) / segments.length;
                
                const drawWheel = () => {
                    segments.forEach((segment, i) => {
                        wheelCtx.beginPath();
                        wheelCtx.moveTo(150, 150);
                        wheelCtx.arc(150, 150, 150, i * segmentAngle, (i + 1) * segmentAngle);
                        wheelCtx.fillStyle = segment.color;
                        wheelCtx.fill();
                        wheelCtx.save();
                        wheelCtx.fillStyle = 'white';
                        wheelCtx.font = 'bold 20px Inter';
                        wheelCtx.translate(150 + 100 * Math.cos(i * segmentAngle + segmentAngle / 2), 150 + 100 * Math.sin(i * segmentAngle + segmentAngle / 2));
                        wheelCtx.rotate(i * segmentAngle + segmentAngle / 2 + Math.PI / 2);
                        wheelCtx.fillText(segment.label, -wheelCtx.measureText(segment.label).width / 2, 0);
                        wheelCtx.restore();
                    });
                };

                window.setup_wheel = () => {
                    document.getElementById('wheel-result').textContent = '';
                    drawWheel();
                };

                document.getElementById('wheel-spin-btn').addEventListener('click', () => {
                    const bet = parseInt(document.querySelector('#modal-wheel .bet-input').value);
                    const resultEl = document.getElementById('wheel-result');
                    const spinBtn = document.getElementById('wheel-spin-btn');
                     if(currentUser.balance < bet) { resultEl.textContent = 'Saldo tidak cukup!'; return; }
                     // For losses, the balance is reduced *after* the result is shown. For wins, the bet is deducted first.
                     if(!resultEl.textContent.includes('Kalah')) { // Don't double deduct on loss
                        currentUser.balance -= bet;
                     }
                     saveUserData();
                     spinBtn.disabled = true;
                     resultEl.textContent = '';
                     resultEl.style.color = ''; // Reset result color

                     const randomSpin = Math.random() * 360 + 360 * 5; // Spin at least 5 times
                     wheelCanvas.style.transform = `rotate(${randomSpin}deg)`;
                     
                     setTimeout(() => {
                        // [BUG FIXED] Correctly calculate the winning segment based on final angle
                        const degreesPerSegment = 360 / segments.length;
                        const finalAngle = randomSpin % 360;
                        // The pointer is at 270 degrees. We find what segment lands there.
                        const normalizedAngle = (270 - finalAngle + 360) % 360;
                        const winningIndex = Math.floor(normalizedAngle / degreesPerSegment);

                        const winningSegment = segments[winningIndex];
                        const multiplier = parseFloat(winningSegment.label.replace('x', ''));
                        
                        // [MODIFIED] Handle both wins and losses
                        const changeAmount = bet * multiplier;
                        currentUser.balance += changeAmount; // This adds winnings or subtracts losses

                        if (changeAmount >= 0) {
                            resultEl.textContent = `Anda dapat ${winningSegment.label}! Menang ${changeAmount.toLocaleString('id-ID')}!`;
                            resultEl.style.color = '#22C55E'; // Green for win
                        } else {
                            // The bet was already deducted, so we only account for the loss multiplier beyond the initial bet
                             resultEl.textContent = `Anda dapat ${winningSegment.label}! Kalah ${Math.abs(changeAmount).toLocaleString('id-ID')}!`;
                             resultEl.style.color = '#EF4444'; // Red for loss
                        }
                         
                         saveUserData();
                         spinBtn.disabled = false;
                     }, 4100);
                });
            }
            // --- START THE APP ---
            initializeApp();
        });
    </script>
</body>
</html>
